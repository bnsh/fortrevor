#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <math.h>
#include <assert.h>
#include "cboe_reader.H"
#include "levenberg_marquardt.H"
#include "bsmodel.H"
#include "bsmodels/bsmodel_base.H"

/* From here on out is generated code. How? By running a few mathematica scripts, specifically
 * gen.m to generate the blackd... derivatives,
 * pgen.m followed by the lex program postprocess to generate the parametrized derivatives
 * vgen.m to generate the derivatives for the volatility with parameters.
 * rgen.m to generate the derivatives for the rates with parameters.
 */

double bsmodel_base::blackdS(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*S*sqrt(T)*v) + (1 + erf((T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*v)))/2.;
	else if (tp == -1) retVal = 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*S*sqrt(T)*v) + (-1 + erf((T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*v)))/2.;
	return(retVal);
}

double bsmodel_base::blackdSdS(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	return(retVal);
}

double bsmodel_base::blackdSdSdS(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3)) - 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,3)*sqrt(T)*v) - 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3)) - 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,3)*sqrt(T)*v) - 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*T*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdSdSdS(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (-3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,4)*pow(T,1.5)*pow(v,3)) + sqrt(2/M_PI)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,3)*pow(T,1.5)*pow(v,3)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,4)*sqrt(T)*v) + sqrt(2/M_PI)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,3)*sqrt(T)*v) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,3)*pow(T,2.5)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,3)*pow(T,2.5)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3)) - (sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,3)*pow(T,2.5)*pow(v,5)) - pow(T*(r + pow(v,2)/2.) + log(S/K),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,3)*pow(T,3.5)*pow(v,7)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,4)*pow(T,2)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,4)*pow(T,2)*pow(v,4)) + (4*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,4)*T*pow(v,2)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,4)*T*pow(v,2)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(pow(S,4)*pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*pow(S,4)*pow(T,2)*pow(v,4));
	else if (tp == -1) retVal = (-3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,4)*pow(T,1.5)*pow(v,3)) + sqrt(2/M_PI)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,3)*pow(T,1.5)*pow(v,3)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,4)*sqrt(T)*v) + sqrt(2/M_PI)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,3)*sqrt(T)*v) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,3)*pow(T,2.5)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,3)*pow(T,2.5)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3)) - (sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,3)*pow(T,2.5)*pow(v,5)) - pow(T*(r + pow(v,2)/2.) + log(S/K),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,3)*pow(T,3.5)*pow(v,7)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,4)*pow(T,2)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,4)*pow(T,2)*pow(v,4)) - (4*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,4)*T*pow(v,2)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,4)*T*pow(v,2)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(pow(S,4)*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*pow(S,4)*pow(T,2)*pow(v,4));
	return(retVal);
}

double bsmodel_base::blackdSdSdSdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,3)*sqrt(T)*pow(v,3))) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,3)*sqrt(T)*pow(v,3)) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,2)*pow(T,1.5)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,7)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*T*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(pow(S,3)*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3));
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,3)*sqrt(T)*pow(v,3))) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,3)*sqrt(T)*pow(v,3)) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,2)*pow(T,1.5)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,7)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*T*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(pow(S,3)*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(pow(S,3)*T*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdSdSdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (-3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,4)) + 3/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,3)*sqrt(T)*pow(v,2)) + 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(S,3)*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,4)) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,2)*pow(T,1.5)*pow(v,4)) - (5*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,6)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*pow(T,2)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,3)*pow(T,2)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*T*pow(v,3)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(pow(S,3)*pow(T,1.5)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*pow(S,3)*pow(T,2)*pow(v,5)) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,3)) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,5));
	else if (tp == -1) retVal = (-3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,4)) + 3/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,3)*sqrt(T)*pow(v,2)) + 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(S,3)*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,4)) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,2)*pow(T,1.5)*pow(v,4)) - (5*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,6)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*pow(T,2)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,3)*pow(T,2)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*T*pow(v,3)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(pow(S,3)*pow(T,1.5)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*pow(S,3)*pow(T,2)*pow(v,5)) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,3)) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,5));
	return(retVal);
}

double bsmodel_base::blackdSdSdSdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (-3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*pow(S,3)*pow(T,2.5)*pow(v,3)) + 3/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*v) + 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*v) + (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,2)*pow(T,2.5)*pow(v,5)) - (5*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,3.5)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(S,3)*T*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*pow(T,2)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,3)*pow(T,2)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*pow(T,1.5)*pow(v,3)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*pow(S,3)*pow(T,2.5)*pow(v,3)) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,3)) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,3)*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3));
	else if (tp == -1) retVal = (-3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*pow(S,3)*pow(T,2.5)*pow(v,3)) + 3/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*v) + 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*v) + (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(S,2)*pow(T,2.5)*pow(v,5)) - (5*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,3.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(pow(S,3)*T*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*pow(T,2)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,3)*pow(T,2)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,3)*pow(T,1.5)*pow(v,3)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*pow(S,3)*pow(T,2.5)*pow(v,3)) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,3)) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,3)*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,3)*T*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,3)*T*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,3)*pow(T,1.5)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdSdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) - 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) - 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	return(retVal);
}

double bsmodel_base::blackdSdSdrdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*pow(S,2)*pow(v,3))) - sqrt(T)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(v,3)) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,5)) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,5)) - pow(T*(r + pow(v,2)/2.) + log(S/K),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,7)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(pow(S,2)*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*pow(S,2)*pow(v,3))) - sqrt(T)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(v,3)) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,5)) + (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,5)) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,5)) - pow(T*(r + pow(v,2)/2.) + log(S/K),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,7)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(pow(S,2)*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	return(retVal);
}

double bsmodel_base::blackdSdSdrdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (-3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,4)) + 3/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,4)) - sqrt(T)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(v,2)) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,4)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,4)) - (5*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,6)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,5)) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4));
	else if (tp == -1) retVal = (-3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,4)) + 3/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,4)) - sqrt(T)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(v,2)) + (sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,4)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,4)) - (5*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,6)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,5)) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(pow(S,2)*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4));
	return(retVal);
}

double bsmodel_base::blackdSdSdrdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,3)) + 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (r + pow(v,2)/2.)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*pow(T,1.5)*pow(v,5)) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,5)) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	else if (tp == -1) retVal = -(exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,3)) + 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (r + pow(v,2)/2.)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*pow(T,1.5)*pow(v,5)) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,5)) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	return(retVal);
}

double bsmodel_base::blackdSdSdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,2))) - sqrt(2/M_PI)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3));
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,2))) - sqrt(2/M_PI)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdSdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,2)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) + (2*sqrt(2/M_PI))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,3)) + 3/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(S,2)*pow(T,1.5)*pow(v,5)) - (6*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*pow(T,1.5)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,5)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*T*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(v,2)) - (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*T*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*pow(T,2)*pow(v,6)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,6)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(pow(S,2)*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,6)) + (-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (2*sqrt(2/M_PI)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,2)) + (3*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*pow(T,1.5)*pow(v,4)) + pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(pow(S,2)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) + (2*sqrt(2/M_PI))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,3)) + 3/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(S,2)*pow(T,1.5)*pow(v,5)) - (6*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*pow(T,1.5)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,5)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*T*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(v,2)) + (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*T*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*pow(T,2)*pow(v,6)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,6)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,3)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(pow(S,2)*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,6)) + (-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (2*sqrt(2/M_PI)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,2)) + (3*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*pow(T,1.5)*pow(v,4)) + pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdSdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,2)) + 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (3*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,4)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,4)) - (9*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*pow(T,2)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,4)) + (-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*v) - ((r + pow(v,2)/2.)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (3*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,3)) - (sqrt(2/M_PI)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,2)) + (3*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,4)) + ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,2)) + 1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (3*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,4)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,4)) - (9*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(pow(S,2)*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*pow(T,2)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*pow(v,4)) + (-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*v) - ((r + pow(v,2)/2.)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (3*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,3)) - (sqrt(2/M_PI)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*sqrt(T)*pow(v,2)) + (3*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,4)) + ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,2)*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*pow(v,4));
	return(retVal);
}

double bsmodel_base::blackdSdSdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*v) - 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (r + pow(v,2)/2.)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,2)) + (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	else if (tp == -1) retVal = -(exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*v) - 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (r + pow(v,2)/2.)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(S,2)*pow(T,2)*pow(v,2)) + (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	return(retVal);
}

double bsmodel_base::blackdSdSdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*v) + 3/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*v) + (3*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,3)) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,3.5)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(pow(S,2)*pow(T,2)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*pow(T,3)*pow(v,2)) + (-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*pow(T,1.5)*pow(v,3)) + (3*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,3)) + pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,2)*pow(T,2)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	else if (tp == -1) retVal = (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*pow(S,2)*pow(T,2.5)*v) + 3/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*v) + (3*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,3)) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,3.5)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(pow(S,2)*pow(T,2)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(S,2)*pow(T,3)*pow(v,2)) + (-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*S*pow(T,1.5)*pow(v,3)) + (3*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,3)) + pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*sqrt(T)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(S,2)*pow(T,1.5)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,2)*T*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(S,2)*pow(T,2)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(S,2)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(S,2)*T*pow(v,2));
	return(retVal);
}

double bsmodel_base::blackdSdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = sqrt(T)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	else if (tp == -1) retVal = sqrt(T)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdrdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(sqrt(T)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3))) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*S*pow(v,3)) - (sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	else if (tp == -1) retVal = -(sqrt(T)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3))) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*S*pow(v,3)) - (sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdrdrdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(pow(T,1.5)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3))) + (sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,5)) + (sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) + (sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) - pow(T*(r + pow(v,2)/2.) + log(S/K),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,7)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,3))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	else if (tp == -1) retVal = -(pow(T,1.5)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3))) + (sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,5)) + (sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) + (sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) - pow(T*(r + pow(v,2)/2.) + log(S/K),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,7)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,3))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdrdrdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (3*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*S*pow(v,4)) - pow(T,1.5)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,4)) + (3*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) - (5*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,6)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(v,5)) - (sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*S*T*pow(v,3));
	else if (tp == -1) retVal = (3*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*S*pow(v,4)) - pow(T,1.5)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,4)) + (3*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) - (5*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,6)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(v,5)) - (sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*S*T*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdrdrdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) - (sqrt(T)*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,5)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,5)) - (sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	else if (tp == -1) retVal = -1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*S*sqrt(T)*pow(v,3)) - (sqrt(T)*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,5)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,5)) - (sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdrdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((sqrt(2/M_PI)*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2))) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,4)) + (sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*T*pow(v,3));
	else if (tp == -1) retVal = -((sqrt(2/M_PI)*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2))) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,4)) + (sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*T*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdrdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (2*sqrt(2/M_PI)*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) + (3*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (6*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,5)) + (sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (2*sqrt(2/M_PI)*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (3*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,4)) + (sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T/pow(v,2) - (4*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,4) - (2*sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3)))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(S*T*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(v,2)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*T*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5));
	else if (tp == -1) retVal = (2*sqrt(2/M_PI)*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) + (3*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (6*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,5)) + (sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (2*sqrt(2/M_PI)*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (3*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,4)) + (sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T/pow(v,2) - (4*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,4) + (2*sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3)))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(S*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(S*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(S*T*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5));
	return(retVal);
}

double bsmodel_base::blackdSdrdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2))) + (3*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,4)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,4)) + (sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - ((r + pow(v,2)/2.)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) - (sqrt(2/M_PI)*sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (3*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,4)) + (sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((r + pow(v,2)/2.)/pow(v,3) + (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,2) + (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*pow(v,2))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*T*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(T,2)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*T*pow(v,3));
	else if (tp == -1) retVal = -(1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2))) + (3*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,4)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,4)) + (sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - ((r + pow(v,2)/2.)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) - (sqrt(2/M_PI)*sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (3*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,4)) + (sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((r + pow(v,2)/2.)/pow(v,3) - (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,2) - (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*pow(v,2))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*T*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*S*pow(T,2)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*T*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdrdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (r + pow(v,2)/2.)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) + (sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	else if (tp == -1) retVal = 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (r + pow(v,2)/2.)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) + (sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdrdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -1/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (r + pow(v,2)/2.)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*pow(v,3)) + (sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,3)) + ((T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) + (sqrt(T)*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-((sqrt(T)*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/v) - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))/(sqrt(T)*v) + (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(4.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(T,1.5)*v) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(4.*sqrt(2*M_PI)*S*pow(T,2.5)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	else if (tp == -1) retVal = -1/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (r + pow(v,2)/2.)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*pow(v,3)) + (sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,3)) + ((T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) + (sqrt(T)*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - ((T*(r + pow(v,2)/2.) + log(S/K))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((sqrt(T)*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/v + (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))/(sqrt(T)*v) - (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(4.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(T,1.5)*v) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(4.*sqrt(2*M_PI)*S*pow(T,2.5)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2))) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) + (sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) + (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v);
	else if (tp == -1) retVal = -(1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2))) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) + (sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) + (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = sqrt(2/M_PI)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(S*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(v,2)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*T*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v);
	else if (tp == -1) retVal = sqrt(2/M_PI)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(S*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*T*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdvdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (-3*sqrt(2/M_PI))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,4)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(S*sqrt(T)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(S*sqrt(T)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,4)) - (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(S*pow(T,1.5)*pow(v,6)) - (5*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,6)) + (sqrt(T)/(sqrt(2)*pow(v,2)) + (sqrt(2)*sqrt(T))/pow(v,2) - (3*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(v,3)) - (9*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*T*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,2)*pow(v,7)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(T,2)*pow(v,7)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(S*sqrt(T)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,4)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(S*pow(T,1.5)*pow(v,6)) + (5*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,6)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*S*pow(T,2)*pow(v,7)) + ((3*T)/v - (12*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) + (12*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,5)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) - (-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*sqrt(2/M_PI)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,3)) + (2*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (sqrt(2/M_PI)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*v) + ((-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) - pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v);
	else if (tp == -1) retVal = (-3*sqrt(2/M_PI))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,4)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI))/(S*sqrt(T)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(S*sqrt(T)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,4)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(S*pow(T,1.5)*pow(v,6)) - (5*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,6)) + (sqrt(T)/(sqrt(2)*pow(v,2)) + (sqrt(2)*sqrt(T))/pow(v,2) - (3*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(v,3)) + (9*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*T*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,2)*pow(v,7)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(T,2)*pow(v,7)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(S*sqrt(T)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,4)) + (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(S*pow(T,1.5)*pow(v,6)) + (5*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,6)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*S*pow(T,2)*pow(v,7)) + ((3*T)/v - (12*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) + (12*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,5)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) - (-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*sqrt(2/M_PI)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,3)) + (2*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (sqrt(2/M_PI)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*v) + ((-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) - pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdvdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3))) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(S*pow(T,1.5)*pow(v,5)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,5)) + (-1/(2.*sqrt(2)*sqrt(T)*v) + (sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*pow(T,1.5)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*S*pow(v,2)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(S*T*pow(v,4)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*T*pow(v,4)) - (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,2)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,1.5)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(S*pow(T,1.5)*pow(v,5)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,5)) + (-1 + (3*(r + pow(v,2)/2.))/pow(v,2) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,4)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,2)*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) - (sqrt(2/M_PI)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + ((1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (sqrt(2/M_PI)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*v) - pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (sqrt(2/M_PI)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,3)) + ((-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(v,2)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*T*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5));
	else if (tp == -1) retVal = -(1/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3))) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(S*pow(T,1.5)*pow(v,5)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,5)) + (-1/(2.*sqrt(2)*sqrt(T)*v) + (sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*pow(T,1.5)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*S*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(S*T*pow(v,4)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*T*pow(v,4)) + (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,2)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,1.5)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(S*pow(T,1.5)*pow(v,5)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,5)) + (-1 + (3*(r + pow(v,2)/2.))/pow(v,2) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,4)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,2)*pow(v,4)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) - (sqrt(2/M_PI)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + ((1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (sqrt(2/M_PI)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*v) - pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (sqrt(2/M_PI)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,3)) + ((-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*T*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,5));
	return(retVal);
}

double bsmodel_base::blackdSdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,2)) + (1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(T,2)*pow(v,3)) + (-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*T*pow(v,3));
	else if (tp == -1) retVal = 1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,2)) + (1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*S*pow(T,2)*pow(v,3)) + (-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*T*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdvdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -3/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*pow(v,2)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,2)) + (-1/(4.*sqrt(2)*pow(T,1.5)) + (r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*pow(v,2)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(S*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(S*pow(T,2)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,2)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,3)*pow(v,3)) + ((2*pow(r + pow(v,2)/2.,2))/(T*pow(v,3)) - (4*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,3)) + (2*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,3)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (3*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*v) - (-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (2*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (sqrt(2/M_PI)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*v) - ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) - pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*T*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*T*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*T*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*pow(T,2)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*S*T*pow(v,3));
	else if (tp == -1) retVal = -3/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*pow(v,2)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*S*pow(T,2.5)*pow(v,2)) + (-1/(4.*sqrt(2)*pow(T,1.5)) + (r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*pow(v,2)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/(sqrt(2*M_PI)*S*T*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(S*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(S*pow(T,2)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,2)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(S*pow(T,3)*pow(v,3)) + ((2*pow(r + pow(v,2)/2.,2))/(T*pow(v,3)) - (4*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,3)) + (2*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,3)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (3*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*v) - (-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (2*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (sqrt(2/M_PI)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*v) - ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) - pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + ((sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*T*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*T*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*pow(T,2)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*S*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*S*T*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdSdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) + ((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	else if (tp == -1) retVal = -1/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) + ((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = 3/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*v) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*S*pow(T,2.5)*v) + (-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	else if (tp == -1) retVal = 3/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*v) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*S*pow(T,2.5)*v) + (-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*pow(T,1.5)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdSdTdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -15/(8.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,3.5)*v) + (15*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(8.*sqrt(2*M_PI)*S*pow(T,3.5)*v) + ((9*(r + pow(v,2)/2.))/(4.*sqrt(2)*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2)*pow(T,3.5)*v))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((3*pow(r + pow(v,2)/2.,2))/(pow(T,2)*pow(v,2)) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,3)*pow(v,2)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,4)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (3*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (9*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*v) + (2*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (sqrt(2/M_PI)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*v) + ((-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (3*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-3*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - ((-3*v)/(8.*pow(T,2.5)) + (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (9*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(4.*sqrt(2*M_PI)*S*pow(T,2.5)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),3))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	else if (tp == -1) retVal = -15/(8.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,3.5)*v) + (15*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(8.*sqrt(2*M_PI)*S*pow(T,3.5)*v) + ((9*(r + pow(v,2)/2.))/(4.*sqrt(2)*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2)*pow(T,3.5)*v))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + ((3*pow(r + pow(v,2)/2.,2))/(pow(T,2)*pow(v,2)) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,3)*pow(v,2)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,4)*pow(v,2)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (3*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (9*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*v) + (2*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (sqrt(2/M_PI)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(T)*v) + ((-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (3*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),3)/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-3*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - ((3*v)/(8.*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (9*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(4.*sqrt(2*M_PI)*S*pow(T,2.5)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(S*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*S*sqrt(T)*v) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(2.*sqrt(2*M_PI)*S*pow(T,1.5)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),3))/(sqrt(2*M_PI)*S*sqrt(T)*v);
	return(retVal);
}

double bsmodel_base::blackdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*v)) + (S*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (K*T*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T));
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*v)) + (S*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (K*T*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T));
	return(retVal);
}

double bsmodel_base::blackdrdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*v) - (K*pow(T,2)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*v) + (K*pow(T,2)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdrdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*pow(v,3)) - (S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5))/(sqrt(2*M_PI)*v) + (K*pow(T,3)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*pow(v,3)) - (S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5))/(sqrt(2*M_PI)*v) - (K*pow(T,3)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdrdrdr(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5))/(sqrt(2*M_PI)*pow(v,3))) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,3.5))/(sqrt(2*M_PI)*v) - (K*pow(T,4)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (sqrt(2/M_PI)*S*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,5)) + (S*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) - (S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,7)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T,1.5)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,3))/(sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5))/(sqrt(2*M_PI)*pow(v,3))) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,3.5))/(sqrt(2*M_PI)*v) + (K*pow(T,4)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (sqrt(2/M_PI)*S*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,5)) + (S*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) - (S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,7)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T,1.5)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/pow(v,3) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,3))/(sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdrdrdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (-3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*pow(v,4)) + (3*S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5))/(sqrt(2*M_PI)*pow(v,2)) + (sqrt(2/M_PI)*S*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(v,2)) - (5*S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,6)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (S*pow(T,1.5)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/v + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*pow(v,3));
	else if (tp == -1) retVal = (-3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*pow(v,4)) + (3*S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5))/(sqrt(2*M_PI)*pow(v,2)) + (sqrt(2/M_PI)*S*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(v,2)) - (5*S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,6)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (S*pow(T,1.5)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/v + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(sqrt(2*M_PI)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdrdrdrdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(2.*sqrt(2*M_PI)*pow(v,3)) - (3*S*sqrt(T))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (5*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(2.*sqrt(2*M_PI)*v) + (3*K*pow(T,2)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (K*r*pow(T,3)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (sqrt(2/M_PI)*S*sqrt(T)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,5)) + (S*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,3)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) - (S*pow(T,1.5)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*v) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/v - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(2.*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(2.*sqrt(2*M_PI)*pow(v,3)) - (3*S*sqrt(T))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (5*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(2.*sqrt(2*M_PI)*v) - (3*K*pow(T,2)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (K*r*pow(T,3)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (sqrt(2/M_PI)*S*sqrt(T)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,5)) + (S*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,3)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) - (S*pow(T,1.5)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (S*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*v) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/v - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2))/(2.*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v,2)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdrdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*pow(v,2))) - (S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (3*S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3));
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*pow(v,2))) - (S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (3*S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdrdrdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T,1.5))/pow(v,3) + (sqrt(2/M_PI)*S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) + (3*S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5))/(sqrt(2*M_PI)*v) - (6*sqrt(2/M_PI)*S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) - (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(v,5)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (sqrt(2/M_PI)*S*pow(T,1.5)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (3*sqrt(2/M_PI)*S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,4)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T/pow(v,2) - (4*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,4) - (2*sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3)))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/pow(v,2) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/pow(v,3) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,2)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/pow(v,4) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T,1.5))/pow(v,3) + (sqrt(2/M_PI)*S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) + (3*S*pow(T,1.5))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2.5))/(sqrt(2*M_PI)*v) - (6*sqrt(2/M_PI)*S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) + (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(v,5)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (sqrt(2/M_PI)*S*pow(T,1.5)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (3*sqrt(2/M_PI)*S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,4)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T/pow(v,2) - (4*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,4) + (2*sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3)))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/pow(v,2) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/pow(v,3) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/pow(v,3) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/pow(v,4) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5));
	return(retVal);
}

double bsmodel_base::blackdrdrdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (-3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(2.*sqrt(2*M_PI)*pow(v,2)) - (3*S*sqrt(T))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (3*S*sqrt(T)*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*pow(v,2)) + (3*S*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,4)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (S*sqrt(T)*(r + pow(v,2)/2.)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (S*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (S*pow(T,1.5)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (3*S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*((r + pow(v,2)/2.)/pow(v,3) + (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,2) + (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*pow(v,2))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(2.*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) + (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3));
	else if (tp == -1) retVal = (-3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(2.*sqrt(2*M_PI)*pow(v,2)) - (3*S*sqrt(T))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (3*S*sqrt(T)*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*pow(v,2)) + (3*S*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,4)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (S*sqrt(T)*(r + pow(v,2)/2.)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (S*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (S*pow(T,1.5)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (3*S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,4)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*((r + pow(v,2)/2.)/pow(v,3) - (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,2) - (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*pow(v,2))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2)))/(2.*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*((T*(r + pow(v,2)/2.) + log(S/K))/pow(v,3) - (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdrdrdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(2.*sqrt(2*M_PI)*v) - (S*sqrt(T)*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (K*T*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/exp(r*T) + (K*r*pow(T,2)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (S*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(2.*sqrt(2*M_PI)*v) - (S*sqrt(T)*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) + (K*T*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/exp(r*T) - (K*r*pow(T,2)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (S*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(2.*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdrdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*sqrt(T)*v) - (S*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (K*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/exp(r*T) + (2*K*r*T*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/exp(r*T) - (K*pow(r,2)*pow(T,2)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (S*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) - 2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*pow(T,2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (sqrt(2/M_PI)*S*sqrt(T)*(r + pow(v,2)/2.)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) - (S*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-((sqrt(T)*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/v) - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))/(sqrt(T)*v) + (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(4.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(4.*sqrt(2*M_PI)*pow(T,1.5)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-1 - (sqrt(T)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v - (-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/v - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T - (sqrt(T)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*sqrt(T)*v) - (S*(r + pow(v,2)/2.))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (K*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/exp(r*T) - (2*K*r*T*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/exp(r*T) + (K*pow(r,2)*pow(T,2)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (S*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) + 2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*pow(T,2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (sqrt(2/M_PI)*S*sqrt(T)*(r + pow(v,2)/2.)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) - (S*(T*(r + pow(v,2)/2.) + log(S/K))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (S*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*((sqrt(T)*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/v + (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))/(sqrt(T)*v) - (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(4.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v)))/(sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v))/(4.*sqrt(2*M_PI)*pow(T,1.5)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-1 + (sqrt(T)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/v + (sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/(2.*sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/v - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-T + (sqrt(T)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/v)*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*pow(v,2)) - (S*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*pow(v,2)) - (S*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T))/pow(v,3)) + (sqrt(2/M_PI)*S*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5)) + (S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (sqrt(2/M_PI)*S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T))/pow(v,3)) + (sqrt(2/M_PI)*S*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5)) + (S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (sqrt(2/M_PI)*S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdvdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T))/pow(v,4) - (3*sqrt(2/M_PI)*S*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T,1.5))/pow(v,2) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*pow(v,2)) - (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,4) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(v,4)) - (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(T)*pow(v,6)) - (5*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,6)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(sqrt(2*M_PI)*sqrt(T)*pow(v,6)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3) - (9*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,5) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,5) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,7)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*T*pow(v,7)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/pow(v,4) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(v,4)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(T)*pow(v,6)) + (5*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,6)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,6)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*T*pow(v,7)) + (S*sqrt(T)*((3*T)/v - (12*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) + (12*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,5))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (sqrt(2/M_PI)*S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) - (S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (3*sqrt(2/M_PI)*S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) + (sqrt(2/M_PI)*S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*v) + (S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (sqrt(2/M_PI)*S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) - (S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T))/pow(v,4) - (3*sqrt(2/M_PI)*S*sqrt(T))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T,1.5))/pow(v,2) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5))/(sqrt(2*M_PI)*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,4) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(v,4)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(T)*pow(v,6)) - (5*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,6)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(sqrt(2*M_PI)*sqrt(T)*pow(v,6)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3) + (9*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,5) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,5) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,7)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*T*pow(v,7)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/pow(v,4) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(v,4)) + (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(T)*pow(v,6)) + (5*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,6)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,6)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*T*pow(v,7)) + (S*sqrt(T)*((3*T)/v - (12*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) + (12*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,5))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (sqrt(2/M_PI)*S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) - (S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (3*sqrt(2/M_PI)*S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) + (sqrt(2/M_PI)*S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*v) + (S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (sqrt(2/M_PI)*S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) - (S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdvdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*sqrt(T)*pow(v,3))) + S/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(2.*sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(r + pow(v,2)/2.))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,2)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,4) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(T)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,5)) + (S*sqrt(T)*(-1 + (3*(r + pow(v,2)/2.))/pow(v,2) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,4)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,2)*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (S*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*S*sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) - (S*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (sqrt(2/M_PI)*S*sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*v) + (S*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (sqrt(2/M_PI)*S*sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) + (S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (sqrt(2/M_PI)*S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,4) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5));
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(sqrt(2*M_PI)*sqrt(T)*pow(v,3))) + S/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,3)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(2.*sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(r + pow(v,2)/2.))/pow(v,3) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,4) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(T)*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(T)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,5)) + (S*sqrt(T)*(-1 + (3*(r + pow(v,2)/2.))/pow(v,2) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,4)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,2)*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (S*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (sqrt(2/M_PI)*S*sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) - (S*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (sqrt(2/M_PI)*S*sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*v) + (S*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (sqrt(2/M_PI)*S*sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,3)) + (S*sqrt(T)*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (sqrt(2/M_PI)*S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*pow(v,2)) + (S*sqrt(T)*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T,1.5)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,4) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,5));
	return(retVal);
}

double bsmodel_base::blackdrdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - S/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (S*sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (S*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (S*sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - S/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (S*sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (S*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (S*sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdrdvdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + S/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,3) + (S*sqrt(T)*((2*pow(r + pow(v,2)/2.,2))/(T*pow(v,3)) - (4*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,3)) + (2*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,3)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (S*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (S*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) - (S*sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (S*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (sqrt(2/M_PI)*S*sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*v) + (S*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (S*sqrt(T)*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(r + pow(v,2)/2.)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,2) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(v,3));
	else if (tp == -1) retVal = -(exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + S/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,3) + (S*sqrt(T)*((2*pow(r + pow(v,2)/2.,2))/(T*pow(v,3)) - (4*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,3)) + (2*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,3)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (S*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (S*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) - (S*sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (S*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (sqrt(2/M_PI)*S*sqrt(T)*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*v) + (S*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (S*sqrt(T)*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(v,2)) + (S*sqrt(T)*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(r + pow(v,2)/2.)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,2) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*pow(v,3));
	return(retVal);
}

double bsmodel_base::blackdrdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*sqrt(T)*v) + S/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (K*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (K*r*T*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = -(exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*sqrt(T)*v) + S/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (K*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (K*r*T*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*sqrt(T)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*pow(T,1.5)*v) - S/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) - (K*r*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/exp(r*T) + (K*pow(r,2)*T*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) + exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*T*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (S*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (S*sqrt(T)*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*pow(T,1.5)*v) - S/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (K*r*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/exp(r*T) - (K*pow(r,2)*T*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) - exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*T*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (S*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (S*sqrt(T)*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdrdTdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (-3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(8.*sqrt(2*M_PI)*pow(T,2.5)*v) + (3*S)/(8.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*v) + (3*K*pow(r,2)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (K*pow(r,3)*T*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*((-3*v)/(8.*pow(T,2.5)) + (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v)))/sqrt(2*M_PI) + exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*T*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) - exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*r*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,2)*T*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*sqrt(T)*((3*pow(r + pow(v,2)/2.,2))/(pow(T,2)*pow(v,2)) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,3)*pow(v,2)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,4)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (3*S*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (3*S*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (sqrt(2/M_PI)*S*sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*v) + (S*sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (3*S*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (S*sqrt(T)*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-3*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - ((-3*v)/(8.*pow(T,2.5)) + (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(2.*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(4.*sqrt(2*M_PI)*pow(T,1.5)*v) + exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) + exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*T*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/v - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(2.*sqrt(2*M_PI)*sqrt(T)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),3))/(sqrt(2*M_PI)*v);
	else if (tp == -1) retVal = (-3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(8.*sqrt(2*M_PI)*pow(T,2.5)*v) + (3*S)/(8.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,2.5)*v) - (3*K*pow(r,2)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (K*pow(r,3)*T*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*((3*v)/(8.*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v)))/sqrt(2*M_PI) - exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*T*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) + exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*r*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,2)*T*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*sqrt(T)*((3*pow(r + pow(v,2)/2.,2))/(pow(T,2)*pow(v,2)) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,3)*pow(v,2)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,4)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (3*S*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) - (3*S*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(4.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*pow(T,1.5)*v) + (sqrt(2/M_PI)*S*sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*v) + (S*sqrt(T)*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) + (3*S*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(2.*exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*sqrt(T)*v) + (S*sqrt(T)*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-3*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - ((3*v)/(8.*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(2.*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(4.*sqrt(2*M_PI)*pow(T,1.5)*v) - exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) - exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*T*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/v - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(2.*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/sqrt(2*M_PI) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),3))/(sqrt(2*M_PI)*v);
	return(retVal);
}

double bsmodel_base::blackdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	return(retVal);
}

double bsmodel_base::blackdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)) + (S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*T*pow(v,4)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)) + (S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*T*pow(v,4)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	return(retVal);
}

double bsmodel_base::blackdvdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T))/pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*pow(v,2)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) + (S*(sqrt(T)/(sqrt(2)*pow(v,2)) + (sqrt(2)*sqrt(T))/pow(v,2) - (3*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T))/pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T))/(sqrt(2*M_PI)*pow(v,2)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) + (S*(sqrt(T)/(sqrt(2)*pow(v,2)) + (sqrt(2)*sqrt(T))/pow(v,2) - (3*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	return(retVal);
}

double bsmodel_base::blackdvdvdvdv(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (6*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T))/pow(v,3) - (12*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,5)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(T)*pow(v,5)) + (6*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(pow(T,1.5)*pow(v,7)) + (S*((-6*sqrt(2)*sqrt(T))/pow(v,3) + (12*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,5))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) - (12*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) + (18*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,6)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),4)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(T,2)*pow(v,8)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),4)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(T,2)*pow(v,8)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(T)*pow(v,5)) - (6*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(pow(T,1.5)*pow(v,7)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),4)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*pow(T,2)*pow(v,8)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*((3*T)/v - (12*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) + (12*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,5))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(sqrt(T)/(sqrt(2)*pow(v,2)) + (sqrt(2)*sqrt(T))/pow(v,2) - (3*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	else if (tp == -1) retVal = (6*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T))/pow(v,3) - (12*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,5)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(T)*pow(v,5)) + (6*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(pow(T,1.5)*pow(v,7)) + (S*((-6*sqrt(2)*sqrt(T))/pow(v,3) + (12*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,5))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*T*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,2) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*T*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,2)) + (12*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,4) - (18*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,6)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),4)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(T,2)*pow(v,8)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),4)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(T,2)*pow(v,8)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(T)*pow(v,5)) - (6*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(pow(T,1.5)*pow(v,7)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),4)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),3))/(sqrt(2*M_PI)*pow(T,2)*pow(v,8)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*((3*T)/v - (12*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,3) + (12*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,5))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(sqrt(T)/(sqrt(2)*pow(v,2)) + (sqrt(2)*sqrt(T))/pow(v,2) - (3*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	return(retVal);
}

double bsmodel_base::blackdvdvdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (-3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,4)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,4)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(2.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,6)) + (S*(3/(2.*sqrt(2)*sqrt(T)*pow(v,2)) - (3*sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,4)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2)*pow(T,1.5)*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(T*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) - (6*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,5)) + (3*sqrt(2)*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(M_PI)*pow(T,2)*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(T,1.5)*pow(v,6)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,6)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-1 + (3*(r + pow(v,2)/2.))/pow(v,2) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,4)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,2)*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-1/(2.*sqrt(2)*sqrt(T)*v) + (sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*pow(T,1.5)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/(sqrt(2)*pow(v,2)) + (sqrt(2)*sqrt(T))/pow(v,2) - (3*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,2) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(T*pow(v,5)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6));
	else if (tp == -1) retVal = (-3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,4)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,4)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3))/(2.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,6)) + (S*(3/(2.*sqrt(2)*sqrt(T)*pow(v,2)) - (3*sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,4)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2)*pow(T,1.5)*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/pow(v,3) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(T*pow(v,5)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/pow(v,3) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(v,3)) + (6*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,5)) - (3*sqrt(2)*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(M_PI)*pow(T,2)*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(T,1.5)*pow(v,6)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2))/(2.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,6)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-1 + (3*(r + pow(v,2)/2.))/pow(v,2) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,4)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,2)*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-1/(2.*sqrt(2)*sqrt(T)*v) + (sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*pow(T,1.5)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/(sqrt(2)*pow(v,2)) + (sqrt(2)*sqrt(T))/pow(v,2) - (3*sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,4)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-T + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/pow(v,2) - (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(T*pow(v,4)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)),2)*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*sqrt(T)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,2) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,2)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/pow(v,3) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(v,3)) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(T*pow(v,5)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),3)*pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,6));
	return(retVal);
}

double bsmodel_base::blackdvdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) + (S*(-1/(2.*sqrt(2)*sqrt(T)*v) + (sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*pow(T,1.5)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*T*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,4)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2)*sqrt(M_PI)*pow(T,2)*pow(v,4)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*T*pow(v,4));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(2.*sqrt(2*M_PI)*sqrt(T)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,3)) + (S*(-1/(2.*sqrt(2)*sqrt(T)*v) + (sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*pow(T,1.5)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(2*M_PI)*T*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(sqrt(2*M_PI)*pow(T,2)*pow(v,4)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*T*pow(v,4));
	return(retVal);
}

double bsmodel_base::blackdvdvdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*pow(T,1.5)*v) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.))/(pow(T,1.5)*pow(v,3)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,3)) + (S*(1/(4.*sqrt(2)*pow(T,1.5)*v) - (sqrt(2)*(r + pow(v,2)/2.))/(pow(T,1.5)*pow(v,3)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2)*pow(T,2.5)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/(sqrt(2*M_PI)*T*pow(v,4)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(T*pow(v,4)) - (sqrt(2)*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(sqrt(M_PI)*pow(T,2)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(r + pow(v,2)/2.,2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,4)) - (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(T,2)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(T,3)*pow(v,4)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*((2*pow(r + pow(v,2)/2.,2))/(T*pow(v,3)) - (4*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,3)) + (2*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,3)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(-1/(4.*sqrt(2)*pow(T,1.5)) + (r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*pow(v,2)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-1/(2.*sqrt(2)*sqrt(T)*v) + (sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*pow(T,1.5)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*T*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*v) - (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(T,1.5)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(T*pow(v,4)) + (2*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(T*pow(v,4)) - (sqrt(2)*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(M_PI)*pow(T,2)*pow(v,4)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*T*pow(v,4));
	else if (tp == -1) retVal = -(exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K)/(4.*sqrt(2*M_PI)*pow(T,1.5)*v) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.))/(pow(T,1.5)*pow(v,3)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,3)) + (S*(1/(4.*sqrt(2)*pow(T,1.5)*v) - (sqrt(2)*(r + pow(v,2)/2.))/(pow(T,1.5)*pow(v,3)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2)*pow(T,2.5)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/(sqrt(2*M_PI)*T*pow(v,4)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(T*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/(pow(T,2)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(r + pow(v,2)/2.,2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(T*pow(v,4)) + (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(T,2)*pow(v,4)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))/(pow(T,3)*pow(v,4)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*((2*pow(r + pow(v,2)/2.,2))/(T*pow(v,3)) - (4*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,3)) + (2*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,3)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(-1/(4.*sqrt(2)*pow(T,1.5)) + (r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*pow(v,2)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-1/(2.*sqrt(2)*sqrt(T)*v) + (sqrt(2)*(r + pow(v,2)/2.))/(sqrt(T)*pow(v,3)) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*pow(T,1.5)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((r + pow(v,2)/2.)/v) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,3)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,2)*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(-(sqrt(T)/(sqrt(2)*v)) + (sqrt(2)*(T*(r + pow(v,2)/2.) + log(S/K)))/(sqrt(T)*pow(v,3)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-((T*(r + pow(v,2)/2.) + log(S/K))/v) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(T*pow(v,3)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*T*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*v) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,3)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(T,1.5)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(T*pow(v,4)) - (2*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(T*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(pow(T,2)*pow(v,4)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(T)*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*v) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(T)*pow(v,3)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(T*(r + pow(v,2)/2.) + log(S/K),2)*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*T*pow(v,4));
	return(retVal);
}

double bsmodel_base::blackdvdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2));
	else if (tp == -1) retVal = (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2));
	return(retVal);
}

double bsmodel_base::blackdvdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -((exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,2))) + (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,2)) + (S*(-1/(4.*sqrt(2)*pow(T,1.5)) + (r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*pow(v,2)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2));
	else if (tp == -1) retVal = -((exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,2))) + (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,2)) + (S*(-1/(4.*sqrt(2)*pow(T,1.5)) + (r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*pow(v,2)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,2)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2));
	return(retVal);
}

double bsmodel_base::blackdvdTdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (9*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(4.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,2)) - (15*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2*M_PI)*pow(T,3.5)*pow(v,2)) + (S*(3/(8.*sqrt(2)*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2)) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2)*pow(T,3.5)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*((3*pow(r + pow(v,2)/2.,2))/(pow(T,2)*pow(v,2)) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,3)*pow(v,2)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,4)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-1/(4.*sqrt(2)*pow(T,1.5)) + (r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*pow(v,2)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-3*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - ((-3*v)/(8.*pow(T,2.5)) + (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (9*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(4.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (3*exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),3))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2));
	else if (tp == -1) retVal = (9*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.))/(4.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,2)) - (15*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2*M_PI)*pow(T,3.5)*pow(v,2)) + (S*(3/(8.*sqrt(2)*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2)) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2)*pow(T,3.5)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*((3*pow(r + pow(v,2)/2.,2))/(pow(T,2)*pow(v,2)) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,3)*pow(v,2)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,4)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-1/(4.*sqrt(2)*pow(T,1.5)) + (r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*pow(v,2)) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(1/(2.*sqrt(2)*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*pow(v,2)) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*pow(v,2)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*(sqrt(T)/sqrt(2) - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(2)*sqrt(T)*pow(v,2)))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-3*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - ((3*v)/(8.*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (9*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(4.*sqrt(2*M_PI)*pow(T,2.5)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(r + pow(v,2)/2.)*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(T)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(r + pow(v,2)/2.)*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2)) - (3*exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/(2.*sqrt(2*M_PI)*pow(T,1.5)*pow(v,2)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(T*(r + pow(v,2)/2.) + log(S/K))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),3))/(sqrt(2*M_PI)*sqrt(T)*pow(v,2));
	return(retVal);
}

double bsmodel_base::blackdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (K*r*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	else if (tp == -1) retVal = -(K*r*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI));
	return(retVal);
}

double bsmodel_base::blackdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(K*pow(r,2)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) + (S*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI);
	else if (tp == -1) retVal = (K*pow(r,2)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) + (S*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI);
	return(retVal);
}

double bsmodel_base::blackdTdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = (K*pow(r,3)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((-3*v)/(8.*pow(T,2.5)) + (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v)))/sqrt(2*M_PI) + (S*((9*(r + pow(v,2)/2.))/(4.*sqrt(2)*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2)*pow(T,3.5)*v)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/sqrt(2*M_PI);
	else if (tp == -1) retVal = -(K*pow(r,3)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((3*v)/(8.*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v)))/sqrt(2*M_PI) + (S*((9*(r + pow(v,2)/2.))/(4.*sqrt(2)*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2)*pow(T,3.5)*v)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (2*S*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/sqrt(2*M_PI);
	return(retVal);
}

double bsmodel_base::blackdTdTdTdT(const double params[]) const {
	double S = current();
	double K = strike();
	double v = volatility(params);
	double r = risk_free_rate(params);
	double T = time_to_expiration();
	double tp = type();
	double retVal = 0.0;
	if (tp == 1) retVal = -(K*pow(r,4)*(1 + erf((-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((15*v)/(16.*pow(T,3.5)) - (15*(r + pow(v,2)/2.))/(2.*pow(T,3.5)*v) + (105*(T*(r + pow(v,2)/2.) + log(S/K)))/(16.*pow(T,4.5)*v)))/sqrt(2*M_PI) + (S*((-15*(r + pow(v,2)/2.))/(2.*sqrt(2)*pow(T,3.5)*v) + (105*(T*(r + pow(v,2)/2.) + log(S/K)))/(16.*sqrt(2)*pow(T,4.5)*v)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*((-3*v)/(8.*pow(T,2.5)) + (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v)))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,2)*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,3)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*((3*pow(r + pow(v,2)/2.,2))/(pow(T,2)*pow(v,2)) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,3)*pow(v,2)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,4)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*((9*(r + pow(v,2)/2.))/(4.*sqrt(2)*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2)*pow(T,3.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-3*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - ((-3*v)/(8.*pow(T,2.5)) + (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*((-3*v)/(8.*pow(T,2.5)) + (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((-3*v)/(8.*pow(T,2.5)) + (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*r*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,2)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(4.*pow(T,1.5)) - (r + pow(v,2)/2.)/(pow(T,1.5)*v) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/sqrt(2*M_PI) + (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/sqrt(2*M_PI) - (exp(-(r*T) - pow(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*pow(-r - (-v/(2.*sqrt(T)) + (r + pow(v,2)/2.)/(sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),3))/sqrt(2*M_PI);
	else if (tp == -1) retVal = (K*pow(r,4)*(1 + erf((sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))/sqrt(2))))/(2.*exp(r*T)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((-15*v)/(16.*pow(T,3.5)) + (15*(r + pow(v,2)/2.))/(2.*pow(T,3.5)*v) - (105*(T*(r + pow(v,2)/2.) + log(S/K)))/(16.*pow(T,4.5)*v)))/sqrt(2*M_PI) + (S*((-15*(r + pow(v,2)/2.))/(2.*sqrt(2)*pow(T,3.5)*v) + (105*(T*(r + pow(v,2)/2.) + log(S/K)))/(16.*sqrt(2)*pow(T,4.5)*v)))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*((3*v)/(8.*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v)))/sqrt(2*M_PI) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,2)*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v)))/sqrt(2*M_PI) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,3)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)))/sqrt(2*M_PI) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*((3*pow(r + pow(v,2)/2.,2))/(pow(T,2)*pow(v,2)) - (6*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,3)*pow(v,2)) + (3*pow(T*(r + pow(v,2)/2.) + log(S/K),2))/(pow(T,4)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*((9*(r + pow(v,2)/2.))/(4.*sqrt(2)*pow(T,2.5)*v) - (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*sqrt(2)*pow(T,3.5)*v))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*(-(pow(r + pow(v,2)/2.,2)/(T*pow(v,2))) + (2*(r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(pow(T,2)*pow(v,2)) - pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(pow(T,3)*pow(v,2)))*(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2))))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (3*S*(-((r + pow(v,2)/2.)/(sqrt(2)*pow(T,1.5)*v)) + (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*sqrt(2)*pow(T,2.5)*v))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),2))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (S*((r + pow(v,2)/2.)/(sqrt(2)*sqrt(T)*v) - (T*(r + pow(v,2)/2.) + log(S/K))/(2.*sqrt(2)*pow(T,1.5)*v))*pow(-(((r + pow(v,2)/2.)*(T*(r + pow(v,2)/2.) + log(S/K)))/(T*pow(v,2))) + pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*pow(T,2)*pow(v,2)),3))/(exp(pow(T*(r + pow(v,2)/2.) + log(S/K),2)/(2.*T*pow(v,2)))*sqrt(M_PI)) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-3*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v)) - ((3*v)/(8.*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*((3*v)/(8.*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*((3*v)/(8.*pow(T,2.5)) - (9*(r + pow(v,2)/2.))/(4.*pow(T,2.5)*v) + (15*(T*(r + pow(v,2)/2.) + log(S/K)))/(8.*pow(T,3.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) - exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*r*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*pow(r,2)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(-pow(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v),2) - (-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)))*(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v))))/sqrt(2*M_PI) + exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*sqrt(2/M_PI)*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(-v/(4.*pow(T,1.5)) + (r + pow(v,2)/2.)/(pow(T,1.5)*v) - (3*(T*(r + pow(v,2)/2.) + log(S/K)))/(4.*pow(T,2.5)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/sqrt(2*M_PI) - (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*r*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),2))/sqrt(2*M_PI) + (exp(-(r*T) - pow(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v),2)/2.)*K*(v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*pow(-r - (v/(2.*sqrt(T)) - (r + pow(v,2)/2.)/(sqrt(T)*v) + (T*(r + pow(v,2)/2.) + log(S/K))/(2.*pow(T,1.5)*v))*(sqrt(T)*v - (T*(r + pow(v,2)/2.) + log(S/K))/(sqrt(T)*v)),3))/sqrt(2*M_PI);
	return(retVal);
}


double bsmodel_base::dS(const double params[]) const {
	double _RdS = RdS(params);
	double _VdS = VdS(params);
	double _blackdS = blackdS(params);
	double _blackdr = blackdr(params);
	double _blackdv = blackdv(params);
	double retVal = _VdS*_blackdv + _RdS*_blackdr + _blackdS;

	return(retVal);
}

double bsmodel_base::dSdS(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _blackdSdS = blackdSdS(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double retVal = _VdSdS*_blackdv + pow(_VdS,2)*_blackdvdv + _RdSdS*_blackdr + pow(_RdS,2)*_blackdrdr + 2*_VdS*(_RdS*_blackdrdv + _blackdSdv) + 2*_RdS*_blackdSdr + _blackdSdS;

	return(retVal);
}

double bsmodel_base::dSdSdS(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdS = RdSdSdS(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdS = VdSdSdS(params);
	double _blackdSdSdS = blackdSdSdS(params);
	double _blackdSdSdr = blackdSdSdr(params);
	double _blackdSdSdv = blackdSdSdv(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _VdSdSdS*_blackdv + pow(_VdS,3)*_blackdvdvdv + _RdSdSdS*_blackdr + pow(_RdS,3)*_blackdrdrdr + 3*_VdSdS*_blackdSdv + 3*pow(_VdS,2)*(_RdS*_blackdrdvdv + _blackdSdvdv) + 3*_RdSdS*_blackdSdr + 3*pow(_RdS,2)*_blackdSdrdr + 3*_VdS*(_VdSdS*_blackdvdv + _RdSdS*_blackdrdv + pow(_RdS,2)*_blackdrdrdv + 2*_RdS*_blackdSdrdv + _blackdSdSdv) + 3*_RdS*(_VdSdS*_blackdrdv + _RdSdS*_blackdrdr + _blackdSdSdr) + _blackdSdSdS;

	return(retVal);
}

double bsmodel_base::dSdSdSdS(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdS = RdSdSdS(params);
	double _RdSdSdSdS = RdSdSdSdS(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdS = VdSdSdS(params);
	double _VdSdSdSdS = VdSdSdSdS(params);
	double _blackdSdSdSdS = blackdSdSdSdS(params);
	double _blackdSdSdSdr = blackdSdSdSdr(params);
	double _blackdSdSdSdv = blackdSdSdSdv(params);
	double _blackdSdSdr = blackdSdSdr(params);
	double _blackdSdSdrdr = blackdSdSdrdr(params);
	double _blackdSdSdrdv = blackdSdSdrdv(params);
	double _blackdSdSdv = blackdSdSdv(params);
	double _blackdSdSdvdv = blackdSdSdvdv(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdSdSdS*_blackdv + 3*pow(_VdSdS,2)*_blackdvdv + pow(_VdS,4)*_blackdvdvdvdv + _RdSdSdSdS*_blackdr + 4*_RdS*_VdSdSdS*_blackdrdv + 3*pow(_RdSdS,2)*_blackdrdr + 4*_RdS*_RdSdSdS*_blackdrdr + 6*pow(_RdS,2)*_RdSdS*_blackdrdrdr + pow(_RdS,4)*_blackdrdrdrdr + 4*_VdSdSdS*_blackdSdv + 4*pow(_VdS,3)*(_RdS*_blackdrdvdvdv + _blackdSdvdvdv) + 4*_RdSdSdS*_blackdSdr + 12*_RdS*_RdSdS*_blackdSdrdr + 4*pow(_RdS,3)*_blackdSdrdrdr + 6*_VdSdS*(pow(_VdS,2)*_blackdvdvdv + _RdSdS*_blackdrdv + pow(_RdS,2)*_blackdrdrdv + 2*_VdS*(_RdS*_blackdrdvdv + _blackdSdvdv) + 2*_RdS*_blackdSdrdv + _blackdSdSdv) + 6*pow(_VdS,2)*(_RdSdS*_blackdrdvdv + pow(_RdS,2)*_blackdrdrdvdv + 2*_RdS*_blackdSdrdvdv + _blackdSdSdvdv) + 6*_RdSdS*_blackdSdSdr + 6*pow(_RdS,2)*_blackdSdSdrdr + 4*_VdS*(_VdSdSdS*_blackdvdv + _RdSdSdS*_blackdrdv + pow(_RdS,3)*_blackdrdrdrdv + 3*_RdSdS*_blackdSdrdv + 3*pow(_RdS,2)*_blackdSdrdrdv + 3*_RdS*(_RdSdS*_blackdrdrdv + _blackdSdSdrdv) + _blackdSdSdSdv) + 4*_RdS*_blackdSdSdSdr + _blackdSdSdSdS;

	return(retVal);
}

double bsmodel_base::dSdSdSdr(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdS = RdSdSdS(params);
	double _RdSdSdSdr = RdSdSdSdr(params);
	double _RdSdSdr = RdSdSdr(params);
	double _RdSdr = RdSdr(params);
	double _Rdr = Rdr(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdS = VdSdSdS(params);
	double _blackdSdSdSdr = blackdSdSdSdr(params);
	double _blackdSdSdr = blackdSdSdr(params);
	double _blackdSdSdrdr = blackdSdSdrdr(params);
	double _blackdSdSdrdv = blackdSdSdrdv(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = _RdSdSdSdr*_blackdr + _Rdr*pow(_VdS,3)*_blackdrdvdvdv + 3*_RdSdSdr*(_RdS*_blackdrdr + _blackdSdr) + 3*_Rdr*pow(_VdS,2)*(_RdS*_blackdrdrdvdv + _blackdSdrdvdv) + 3*_RdSdr*(_VdSdS*_blackdrdv + pow(_VdS,2)*_blackdrdvdv + _RdSdS*_blackdrdr + pow(_RdS,2)*_blackdrdrdr + 2*_VdS*(_RdS*_blackdrdrdv + _blackdSdrdv) + 2*_RdS*_blackdSdrdr + _blackdSdSdr) + 3*_VdS*(_RdSdSdr*_blackdrdv + _Rdr*(_VdSdS*_blackdrdvdv + _RdSdS*_blackdrdrdv + pow(_RdS,2)*_blackdrdrdrdv + 2*_RdS*_blackdSdrdrdv + _blackdSdSdrdv)) + _Rdr*(_VdSdSdS*_blackdrdv + _RdSdSdS*_blackdrdr + pow(_RdS,3)*_blackdrdrdrdr + 3*_VdSdS*_blackdSdrdv + 3*_RdSdS*_blackdSdrdr + 3*pow(_RdS,2)*_blackdSdrdrdr + 3*_RdS*(_VdSdS*_blackdrdrdv + _RdSdS*_blackdrdrdr + _blackdSdSdrdr) + _blackdSdSdSdr);

	return(retVal);
}

double bsmodel_base::dSdSdSdv(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdS = RdSdSdS(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdS = VdSdSdS(params);
	double _VdSdSdSdv = VdSdSdSdv(params);
	double _VdSdSdv = VdSdSdv(params);
	double _VdSdv = VdSdv(params);
	double _Vdv = Vdv(params);
	double _blackdSdSdSdv = blackdSdSdSdv(params);
	double _blackdSdSdrdv = blackdSdSdrdv(params);
	double _blackdSdSdv = blackdSdSdv(params);
	double _blackdSdSdvdv = blackdSdSdvdv(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdSdSdv*_blackdv + _Vdv*pow(_VdS,3)*_blackdvdvdvdv + 3*_VdSdSdv*(_RdS*_blackdrdv + _blackdSdv) + 3*_Vdv*pow(_VdS,2)*(_RdS*_blackdrdvdvdv + _blackdSdvdvdv) + 3*_VdSdv*(_VdSdS*_blackdvdv + pow(_VdS,2)*_blackdvdvdv + _RdSdS*_blackdrdv + pow(_RdS,2)*_blackdrdrdv + 2*_VdS*(_RdS*_blackdrdvdv + _blackdSdvdv) + 2*_RdS*_blackdSdrdv + _blackdSdSdv) + 3*_VdS*(_VdSdSdv*_blackdvdv + _Vdv*(_VdSdS*_blackdvdvdv + _RdSdS*_blackdrdvdv + pow(_RdS,2)*_blackdrdrdvdv + 2*_RdS*_blackdSdrdvdv + _blackdSdSdvdv)) + _Vdv*(_VdSdSdS*_blackdvdv + _RdSdSdS*_blackdrdv + pow(_RdS,3)*_blackdrdrdrdv + 3*_VdSdS*_blackdSdvdv + 3*_RdSdS*_blackdSdrdv + 3*pow(_RdS,2)*_blackdSdrdrdv + 3*_RdS*(_VdSdS*_blackdrdvdv + _RdSdS*_blackdrdrdv + _blackdSdSdrdv) + _blackdSdSdSdv);

	return(retVal);
}

double bsmodel_base::dSdSdSdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdS = RdSdSdS(params);
	double _RdSdSdSdT = RdSdSdSdT(params);
	double _RdSdSdT = RdSdSdT(params);
	double _RdSdT = RdSdT(params);
	double _RdT = RdT(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdS = VdSdSdS(params);
	double _VdSdSdSdT = VdSdSdSdT(params);
	double _VdSdSdT = VdSdSdT(params);
	double _VdSdT = VdSdT(params);
	double _VdT = VdT(params);
	double _blackdSdSdSdT = blackdSdSdSdT(params);
	double _blackdSdSdSdr = blackdSdSdSdr(params);
	double _blackdSdSdSdv = blackdSdSdSdv(params);
	double _blackdSdSdr = blackdSdSdr(params);
	double _blackdSdSdrdT = blackdSdSdrdT(params);
	double _blackdSdSdrdr = blackdSdSdrdr(params);
	double _blackdSdSdrdv = blackdSdSdrdv(params);
	double _blackdSdSdv = blackdSdSdv(params);
	double _blackdSdSdvdT = blackdSdSdvdT(params);
	double _blackdSdSdvdv = blackdSdSdvdv(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdT = blackdSdrdT(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdT = blackdSdrdrdT(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdT = blackdSdrdvdT(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdT = blackdSdvdT(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdT = blackdSdvdvdT(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdSdSdT*_blackdv + 3*_VdS*(_VdSdSdT*_blackdvdv + _VdSdS*_blackdvdvdT) + pow(_VdS,3)*_blackdvdvdvdT + _RdSdSdSdT*_blackdr + _RdSdSdS*_blackdrdT + 3*_RdSdT*_VdSdS*_blackdrdv + 3*_VdS*_RdSdSdT*_blackdrdv + 3*_RdS*_VdSdSdT*_blackdrdv + _VdSdSdS*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + 3*_VdSdT*(_VdSdS*_blackdvdv + pow(_VdS,2)*_blackdvdvdv + _RdSdS*_blackdrdv) + 3*_VdS*_RdSdS*_blackdrdvdT + 3*_RdS*_VdSdS*_blackdrdvdT + 3*pow(_VdS,2)*_RdSdT*_blackdrdvdv + 6*_RdS*_VdS*_VdSdT*_blackdrdvdv + 3*_RdT*_VdS*_VdSdS*_blackdrdvdv + 3*_RdS*pow(_VdS,2)*_blackdrdvdvdT + _RdT*pow(_VdS,3)*_blackdrdvdvdv + 3*_RdSdT*_RdSdS*_blackdrdr + 3*_RdS*_RdSdSdT*_blackdrdr + _RdT*_RdSdSdS*_blackdrdr + 3*_RdS*_RdSdS*_blackdrdrdT + 6*_RdS*_VdS*_RdSdT*_blackdrdrdv + 3*pow(_RdS,2)*_VdSdT*_blackdrdrdv + 3*_RdT*_VdS*_RdSdS*_blackdrdrdv + 3*_RdT*_RdS*_VdSdS*_blackdrdrdv + 3*pow(_RdS,2)*_VdS*_blackdrdrdvdT + 3*_RdT*_RdS*pow(_VdS,2)*_blackdrdrdvdv + 3*pow(_RdS,2)*_RdSdT*_blackdrdrdr + 3*_RdT*_RdS*_RdSdS*_blackdrdrdr + pow(_RdS,3)*_blackdrdrdrdT + 3*_RdT*pow(_RdS,2)*_VdS*_blackdrdrdrdv + _RdT*pow(_RdS,3)*_blackdrdrdrdr + 3*_VdSdSdT*_blackdSdv + 3*_VdSdS*_blackdSdvdT + 6*_VdS*_VdSdT*_blackdSdvdv + 3*pow(_VdS,2)*_blackdSdvdvdT + 3*_RdSdSdT*_blackdSdr + 3*_RdSdS*_blackdSdrdT + 6*_VdS*_RdSdT*_blackdSdrdv + 6*_RdS*_VdSdT*_blackdSdrdv + 3*_RdT*_VdSdS*_blackdSdrdv + 6*_RdS*_VdS*_blackdSdrdvdT + 3*_RdT*pow(_VdS,2)*_blackdSdrdvdv + 6*_RdS*_RdSdT*_blackdSdrdr + 3*_RdT*_RdSdS*_blackdSdrdr + 3*pow(_RdS,2)*_blackdSdrdrdT + 6*_RdT*_RdS*_VdS*_blackdSdrdrdv + 3*_RdT*pow(_RdS,2)*_blackdSdrdrdr + 3*_VdSdT*_blackdSdSdv + 3*_VdS*_blackdSdSdvdT + 3*_RdSdT*_blackdSdSdr + 3*_RdS*_blackdSdSdrdT + 3*_RdT*_VdS*_blackdSdSdrdv + 3*_RdT*_RdS*_blackdSdSdrdr + _blackdSdSdSdT + _VdT*(pow(_VdS,3)*_blackdvdvdvdv + _RdSdSdS*_blackdrdv + pow(_RdS,3)*_blackdrdrdrdv + 3*_VdSdS*_blackdSdvdv + 3*pow(_VdS,2)*(_RdS*_blackdrdvdvdv + _blackdSdvdvdv) + 3*_RdSdS*_blackdSdrdv + 3*pow(_RdS,2)*_blackdSdrdrdv + 3*_VdS*(_VdSdS*_blackdvdvdv + _RdSdS*_blackdrdvdv + pow(_RdS,2)*_blackdrdrdvdv + 2*_RdS*_blackdSdrdvdv + _blackdSdSdvdv) + 3*_RdS*(_VdSdS*_blackdrdvdv + _RdSdS*_blackdrdrdv + _blackdSdSdrdv) + _blackdSdSdSdv) + _RdT*_blackdSdSdSdr;

	return(retVal);
}

double bsmodel_base::dSdSdr(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdr = RdSdSdr(params);
	double _RdSdr = RdSdr(params);
	double _Rdr = Rdr(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _blackdSdSdr = blackdSdSdr(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _RdSdSdr*_blackdr + _Rdr*pow(_VdS,2)*_blackdrdvdv + 2*_RdSdr*(_RdS*_blackdrdr + _blackdSdr) + 2*_VdS*(_RdSdr*_blackdrdv + _Rdr*(_RdS*_blackdrdrdv + _blackdSdrdv)) + _Rdr*(_VdSdS*_blackdrdv + _RdSdS*_blackdrdr + pow(_RdS,2)*_blackdrdrdr + 2*_RdS*_blackdSdrdr + _blackdSdSdr);

	return(retVal);
}

double bsmodel_base::dSdSdrdr(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdr = RdSdSdr(params);
	double _RdSdSdrdr = RdSdSdrdr(params);
	double _RdSdr = RdSdr(params);
	double _RdSdrdr = RdSdrdr(params);
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _blackdSdSdr = blackdSdSdr(params);
	double _blackdSdSdrdr = blackdSdSdrdr(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _RdSdSdrdr*_blackdr + 2*(pow(_RdSdr,2) + _RdS*_RdSdrdr)*_blackdrdr + pow(_VdS,2)*(_Rdrdr*_blackdrdvdv + pow(_Rdr,2)*_blackdrdrdvdv) + 2*_RdSdrdr*_blackdSdr + 2*_VdS*(_RdSdrdr*_blackdrdv + _Rdrdr*(_RdS*_blackdrdrdv + _blackdSdrdv) + _Rdr*(2*_RdSdr*_blackdrdrdv + _Rdr*(_RdS*_blackdrdrdrdv + _blackdSdrdrdv))) + _Rdrdr*(_VdSdS*_blackdrdv + _RdSdS*_blackdrdr + pow(_RdS,2)*_blackdrdrdr + 2*_RdS*_blackdSdrdr + _blackdSdSdr) + _Rdr*(2*_RdSdSdr*_blackdrdr + 4*_RdSdr*(_RdS*_blackdrdrdr + _blackdSdrdr) + _Rdr*(_VdSdS*_blackdrdrdv + _RdSdS*_blackdrdrdr + pow(_RdS,2)*_blackdrdrdrdr + 2*_RdS*_blackdSdrdrdr + _blackdSdSdrdr));

	return(retVal);
}

double bsmodel_base::dSdSdrdv(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdr = RdSdSdr(params);
	double _RdSdr = RdSdr(params);
	double _Rdr = Rdr(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdv = VdSdSdv(params);
	double _VdSdv = VdSdv(params);
	double _Vdv = Vdv(params);
	double _blackdSdSdrdv = blackdSdSdrdv(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = 2*_RdSdr*(_VdSdv*_blackdrdv + _Vdv*(_VdS*_blackdrdvdv + _RdS*_blackdrdrdv + _blackdSdrdv)) + _Rdr*(_VdSdSdv*_blackdrdv + 2*_VdSdv*(_VdS*_blackdrdvdv + _RdS*_blackdrdrdv + _blackdSdrdv)) + _Vdv*(_RdSdSdr*_blackdrdv + _Rdr*(_VdSdS*_blackdrdvdv + pow(_VdS,2)*_blackdrdvdvdv + _RdSdS*_blackdrdrdv + pow(_RdS,2)*_blackdrdrdrdv + 2*_VdS*(_RdS*_blackdrdrdvdv + _blackdSdrdvdv) + 2*_RdS*_blackdSdrdrdv + _blackdSdSdrdv));

	return(retVal);
}

double bsmodel_base::dSdSdrdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdT = RdSdSdT(params);
	double _RdSdSdr = RdSdSdr(params);
	double _RdSdSdrdT = RdSdSdrdT(params);
	double _RdSdT = RdSdT(params);
	double _RdSdr = RdSdr(params);
	double _RdSdrdT = RdSdrdT(params);
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdT = VdSdSdT(params);
	double _VdSdT = VdSdT(params);
	double _VdT = VdT(params);
	double _blackdSdSdr = blackdSdSdr(params);
	double _blackdSdSdrdT = blackdSdSdrdT(params);
	double _blackdSdSdrdr = blackdSdSdrdr(params);
	double _blackdSdSdrdv = blackdSdSdrdv(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdT = blackdSdrdT(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdT = blackdSdrdrdT(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdT = blackdSdrdvdT(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = _RdSdSdrdT*_blackdr + (_RdrdT*_VdSdS + _Rdr*_VdSdSdT)*_blackdrdv + _Rdr*_VdSdS*_blackdrdvdT + 2*_VdS*(_RdSdrdT*_blackdrdv + _RdSdr*_blackdrdvdT) + _RdrdT*pow(_VdS,2)*_blackdrdvdv + 2*_VdSdT*(_RdSdr*_blackdrdv + _Rdr*_VdS*_blackdrdvdv) + _Rdr*pow(_VdS,2)*_blackdrdvdvdT + 2*_RdSdT*_RdSdr*_blackdrdr + 2*_RdS*_RdSdrdT*_blackdrdr + _RdrdT*_RdSdS*_blackdrdr + _Rdr*_RdSdSdT*_blackdrdr + _RdSdSdr*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + 2*_RdS*_RdSdr*_blackdrdrdT + _Rdr*_RdSdS*_blackdrdrdT + 2*_RdrdT*_RdS*_VdS*_blackdrdrdv + 2*_Rdr*_VdS*_RdSdT*_blackdrdrdv + 2*_Rdr*_RdS*_VdSdT*_blackdrdrdv + 2*_RdT*_VdS*_RdSdr*_blackdrdrdv + _RdT*_Rdr*_VdSdS*_blackdrdrdv + 2*_Rdr*_RdS*_VdS*_blackdrdrdvdT + _RdT*_Rdr*pow(_VdS,2)*_blackdrdrdvdv + _RdrdT*pow(_RdS,2)*_blackdrdrdr + 2*_Rdr*_RdS*_RdSdT*_blackdrdrdr + 2*_RdT*_RdS*_RdSdr*_blackdrdrdr + _RdT*_Rdr*_RdSdS*_blackdrdrdr + _Rdr*pow(_RdS,2)*_blackdrdrdrdT + 2*_RdT*_Rdr*_RdS*_VdS*_blackdrdrdrdv + _RdT*_Rdr*pow(_RdS,2)*_blackdrdrdrdr + 2*_RdSdrdT*_blackdSdr + 2*_RdSdr*_blackdSdrdT + 2*_RdrdT*_VdS*_blackdSdrdv + 2*_Rdr*_VdSdT*_blackdSdrdv + 2*_Rdr*_VdS*_blackdSdrdvdT + 2*_RdrdT*_RdS*_blackdSdrdr + 2*_Rdr*_RdSdT*_blackdSdrdr + 2*_RdT*_RdSdr*_blackdSdrdr + 2*_Rdr*_RdS*_blackdSdrdrdT + 2*_RdT*_Rdr*_VdS*_blackdSdrdrdv + 2*_RdT*_Rdr*_RdS*_blackdSdrdrdr + _RdrdT*_blackdSdSdr + _Rdr*_blackdSdSdrdT + _VdT*(_Rdr*pow(_VdS,2)*_blackdrdvdvdv + 2*_RdSdr*(_RdS*_blackdrdrdv + _blackdSdrdv) + 2*_VdS*(_RdSdr*_blackdrdvdv + _Rdr*(_RdS*_blackdrdrdvdv + _blackdSdrdvdv)) + _Rdr*(_VdSdS*_blackdrdvdv + _RdSdS*_blackdrdrdv + pow(_RdS,2)*_blackdrdrdrdv + 2*_RdS*_blackdSdrdrdv + _blackdSdSdrdv)) + _RdT*_Rdr*_blackdSdSdrdr;

	return(retVal);
}

double bsmodel_base::dSdSdv(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdv = VdSdSdv(params);
	double _VdSdv = VdSdv(params);
	double _Vdv = Vdv(params);
	double _blackdSdSdv = blackdSdSdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _VdSdSdv*_blackdv + _Vdv*pow(_VdS,2)*_blackdvdvdv + 2*_VdSdv*(_RdS*_blackdrdv + _blackdSdv) + 2*_VdS*(_VdSdv*_blackdvdv + _Vdv*(_RdS*_blackdrdvdv + _blackdSdvdv)) + _Vdv*(_VdSdS*_blackdvdv + _RdSdS*_blackdrdv + pow(_RdS,2)*_blackdrdrdv + 2*_RdS*_blackdSdrdv + _blackdSdSdv);

	return(retVal);
}

double bsmodel_base::dSdSdvdv(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdv = VdSdSdv(params);
	double _VdSdSdvdv = VdSdSdvdv(params);
	double _VdSdv = VdSdv(params);
	double _VdSdvdv = VdSdvdv(params);
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _blackdSdSdv = blackdSdSdv(params);
	double _blackdSdSdvdv = blackdSdSdvdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdSdvdv*_blackdv + 2*pow(_VdSdv,2)*_blackdvdv + _Vdvdv*_VdSdS*_blackdvdv + 2*_Vdv*_VdSdSdv*_blackdvdv + pow(_Vdv,2)*_VdSdS*_blackdvdvdv + pow(_VdS,2)*(_Vdvdv*_blackdvdvdv + pow(_Vdv,2)*_blackdvdvdvdv) + _Vdvdv*_RdSdS*_blackdrdv + pow(_Vdv,2)*_RdSdS*_blackdrdvdv + _Vdvdv*pow(_RdS,2)*_blackdrdrdv + pow(_Vdv,2)*pow(_RdS,2)*_blackdrdrdvdv + 2*_VdSdvdv*(_RdS*_blackdrdv + _blackdSdv) + 4*_Vdv*_VdSdv*(_VdS*_blackdvdvdv + _RdS*_blackdrdvdv + _blackdSdvdv) + 2*_VdS*(_VdSdvdv*_blackdvdv + _Vdvdv*(_RdS*_blackdrdvdv + _blackdSdvdv) + pow(_Vdv,2)*(_RdS*_blackdrdvdvdv + _blackdSdvdvdv)) + 2*_Vdvdv*_RdS*_blackdSdrdv + 2*pow(_Vdv,2)*_RdS*_blackdSdrdvdv + _Vdvdv*_blackdSdSdv + pow(_Vdv,2)*_blackdSdSdvdv;

	return(retVal);
}

double bsmodel_base::dSdSdvdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdT = RdSdSdT(params);
	double _RdSdT = RdSdT(params);
	double _RdT = RdT(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdT = VdSdSdT(params);
	double _VdSdSdv = VdSdSdv(params);
	double _VdSdSdvdT = VdSdSdvdT(params);
	double _VdSdT = VdSdT(params);
	double _VdSdv = VdSdv(params);
	double _VdSdvdT = VdSdvdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _blackdSdSdrdv = blackdSdSdrdv(params);
	double _blackdSdSdv = blackdSdSdv(params);
	double _blackdSdSdvdT = blackdSdSdvdT(params);
	double _blackdSdSdvdv = blackdSdSdvdv(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdT = blackdSdrdvdT(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdT = blackdSdvdT(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdT = blackdSdvdvdT(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdSdvdT*_blackdv + (_VdvdT*_VdSdS + _Vdv*_VdSdSdT)*_blackdvdv + _Vdv*_VdSdS*_blackdvdvdT + 2*_VdS*(_VdSdvdT*_blackdvdv + _VdSdv*_blackdvdvdT) + _VdvdT*pow(_VdS,2)*_blackdvdvdv + 2*_VdSdT*(_VdSdv*_blackdvdv + _Vdv*_VdS*_blackdvdvdv) + _Vdv*pow(_VdS,2)*_blackdvdvdvdT + 2*_RdSdT*_VdSdv*_blackdrdv + 2*_RdS*_VdSdvdT*_blackdrdv + _VdvdT*_RdSdS*_blackdrdv + _Vdv*_RdSdSdT*_blackdrdv + _VdSdSdv*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + 2*_RdS*_VdSdv*_blackdrdvdT + _Vdv*_RdSdS*_blackdrdvdT + 2*_VdvdT*_RdS*_VdS*_blackdrdvdv + 2*_Vdv*_VdS*_RdSdT*_blackdrdvdv + 2*_Vdv*_RdS*_VdSdT*_blackdrdvdv + 2*_RdT*_VdS*_VdSdv*_blackdrdvdv + _RdT*_Vdv*_VdSdS*_blackdrdvdv + 2*_Vdv*_RdS*_VdS*_blackdrdvdvdT + _RdT*_Vdv*pow(_VdS,2)*_blackdrdvdvdv + _VdvdT*pow(_RdS,2)*_blackdrdrdv + 2*_Vdv*_RdS*_RdSdT*_blackdrdrdv + 2*_RdT*_RdS*_VdSdv*_blackdrdrdv + _RdT*_Vdv*_RdSdS*_blackdrdrdv + _Vdv*pow(_RdS,2)*_blackdrdrdvdT + 2*_RdT*_Vdv*_RdS*_VdS*_blackdrdrdvdv + _RdT*_Vdv*pow(_RdS,2)*_blackdrdrdrdv + 2*_VdSdvdT*_blackdSdv + 2*_VdSdv*_blackdSdvdT + 2*_VdvdT*_VdS*_blackdSdvdv + 2*_Vdv*_VdSdT*_blackdSdvdv + 2*_Vdv*_VdS*_blackdSdvdvdT + 2*_VdvdT*_RdS*_blackdSdrdv + 2*_Vdv*_RdSdT*_blackdSdrdv + 2*_RdT*_VdSdv*_blackdSdrdv + 2*_Vdv*_RdS*_blackdSdrdvdT + 2*_RdT*_Vdv*_VdS*_blackdSdrdvdv + 2*_RdT*_Vdv*_RdS*_blackdSdrdrdv + _VdvdT*_blackdSdSdv + _Vdv*_blackdSdSdvdT + _VdT*(_Vdv*pow(_VdS,2)*_blackdvdvdvdv + 2*_VdSdv*(_RdS*_blackdrdvdv + _blackdSdvdv) + 2*_VdS*(_VdSdv*_blackdvdvdv + _Vdv*(_RdS*_blackdrdvdvdv + _blackdSdvdvdv)) + _Vdv*(_VdSdS*_blackdvdvdv + _RdSdS*_blackdrdvdv + pow(_RdS,2)*_blackdrdrdvdv + 2*_RdS*_blackdSdrdvdv + _blackdSdSdvdv)) + _RdT*_Vdv*_blackdSdSdrdv;

	return(retVal);
}

double bsmodel_base::dSdSdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdT = RdSdSdT(params);
	double _RdSdT = RdSdT(params);
	double _RdT = RdT(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdT = VdSdSdT(params);
	double _VdSdT = VdSdT(params);
	double _VdT = VdT(params);
	double _blackdSdSdT = blackdSdSdT(params);
	double _blackdSdSdr = blackdSdSdr(params);
	double _blackdSdSdv = blackdSdSdv(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdT = blackdSdrdT(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdT = blackdSdvdT(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _VdSdSdT*_blackdv + _RdSdSdT*_blackdr + _RdSdS*_blackdrdT + 2*_RdS*_VdSdT*_blackdrdv + _VdT*_RdSdS*_blackdrdv + _VdSdS*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + pow(_VdS,2)*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv) + 2*_RdS*_RdSdT*_blackdrdr + _RdT*_RdSdS*_blackdrdr + pow(_RdS,2)*_blackdrdrdT + _VdT*pow(_RdS,2)*_blackdrdrdv + _RdT*pow(_RdS,2)*_blackdrdrdr + 2*_VdSdT*_blackdSdv + 2*_RdSdT*_blackdSdr + 2*_RdS*_blackdSdrdT + 2*_VdT*_RdS*_blackdSdrdv + 2*_VdS*(_VdSdT*_blackdvdv + _RdSdT*_blackdrdv + _RdS*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + _blackdSdvdT + _VdT*_blackdSdvdv + _RdT*_blackdSdrdv) + 2*_RdT*_RdS*_blackdSdrdr + _blackdSdSdT + _VdT*_blackdSdSdv + _RdT*_blackdSdSdr;

	return(retVal);
}

double bsmodel_base::dSdSdTdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdS = RdSdS(params);
	double _RdSdSdT = RdSdSdT(params);
	double _RdSdSdTdT = RdSdSdTdT(params);
	double _RdSdT = RdSdT(params);
	double _RdSdTdT = RdSdTdT(params);
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _VdS = VdS(params);
	double _VdSdS = VdSdS(params);
	double _VdSdSdT = VdSdSdT(params);
	double _VdSdSdTdT = VdSdSdTdT(params);
	double _VdSdT = VdSdT(params);
	double _VdSdTdT = VdSdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _blackdSdSdTdT = blackdSdSdTdT(params);
	double _blackdSdSdr = blackdSdSdr(params);
	double _blackdSdSdrdT = blackdSdSdrdT(params);
	double _blackdSdSdrdr = blackdSdSdrdr(params);
	double _blackdSdSdrdv = blackdSdSdrdv(params);
	double _blackdSdSdv = blackdSdSdv(params);
	double _blackdSdSdvdT = blackdSdSdvdT(params);
	double _blackdSdSdvdv = blackdSdSdvdv(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdT = blackdSdrdT(params);
	double _blackdSdrdTdT = blackdSdrdTdT(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdT = blackdSdrdrdT(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdT = blackdSdrdvdT(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdT = blackdSdvdT(params);
	double _blackdSdvdTdT = blackdSdvdTdT(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdT = blackdSdvdvdT(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdTdT = blackdrdTdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdTdT = blackdrdrdTdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdTdT = blackdrdvdTdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdTdT = blackdvdTdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdTdT = blackdvdvdTdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdSdTdT*_blackdv + 2*pow(_VdSdT,2)*_blackdvdv + _VdSdS*(_blackdvdTdT + _VdTdT*_blackdvdv) + 4*_VdS*_VdSdT*_blackdvdvdT + _VdS*(2*_VdSdTdT*_blackdvdv + _VdS*(_blackdvdvdTdT + _VdTdT*_blackdvdvdv)) + _RdSdSdTdT*_blackdr + 2*_RdSdSdT*_blackdrdT + _RdSdS*_blackdrdTdT + 4*_RdSdT*_VdSdT*_blackdrdv + 2*_VdS*_RdSdTdT*_blackdrdv + 2*_RdS*_VdSdTdT*_blackdrdv + _VdTdT*_RdSdS*_blackdrdv + _RdTdT*_VdSdS*_blackdrdv + 2*_VdSdSdT*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + 4*_VdS*_RdSdT*_blackdrdvdT + 4*_RdS*_VdSdT*_blackdrdvdT + 2*_RdT*_VdSdS*_blackdrdvdT + 2*_RdS*_VdS*_blackdrdvdTdT + 2*_VdTdT*_RdS*_VdS*_blackdrdvdv + _RdTdT*pow(_VdS,2)*_blackdrdvdv + 4*_RdT*_VdS*_VdSdT*_blackdrdvdv + 2*_RdT*pow(_VdS,2)*_blackdrdvdvdT + 2*pow(_RdSdT,2)*_blackdrdr + 2*_RdS*_RdSdTdT*_blackdrdr + _RdTdT*_RdSdS*_blackdrdr + 2*_RdT*_RdSdSdT*_blackdrdr + 4*_RdS*_RdSdT*_blackdrdrdT + 2*_RdT*_RdSdS*_blackdrdrdT + pow(_RdS,2)*_blackdrdrdTdT + _VdTdT*pow(_RdS,2)*_blackdrdrdv + 2*_RdTdT*_RdS*_VdS*_blackdrdrdv + 4*_RdT*_VdS*_RdSdT*_blackdrdrdv + 4*_RdT*_RdS*_VdSdT*_blackdrdrdv + pow(_RdT,2)*_VdSdS*_blackdrdrdv + 4*_RdT*_RdS*_VdS*_blackdrdrdvdT + pow(_RdT,2)*pow(_VdS,2)*_blackdrdrdvdv + _RdTdT*pow(_RdS,2)*_blackdrdrdr + 4*_RdT*_RdS*_RdSdT*_blackdrdrdr + pow(_RdT,2)*_RdSdS*_blackdrdrdr + 2*_RdT*pow(_RdS,2)*_blackdrdrdrdT + 2*pow(_RdT,2)*_RdS*_VdS*_blackdrdrdrdv + pow(_RdT,2)*pow(_RdS,2)*_blackdrdrdrdr + 2*_VdSdTdT*_blackdSdv + 4*_VdSdT*_blackdSdvdT + 2*_VdS*_blackdSdvdTdT + 2*_VdTdT*_VdS*_blackdSdvdv + 2*_RdSdTdT*_blackdSdr + 4*_RdSdT*_blackdSdrdT + 2*_RdS*_blackdSdrdTdT + 2*_VdTdT*_RdS*_blackdSdrdv + 2*_RdTdT*_VdS*_blackdSdrdv + 4*_RdT*_VdSdT*_blackdSdrdv + 4*_RdT*_VdS*_blackdSdrdvdT + 2*_RdTdT*_RdS*_blackdSdrdr + 4*_RdT*_RdSdT*_blackdSdrdr + 4*_RdT*_RdS*_blackdSdrdrdT + 2*pow(_RdT,2)*_VdS*_blackdSdrdrdv + 2*pow(_RdT,2)*_RdS*_blackdSdrdrdr + _blackdSdSdTdT + _VdTdT*_blackdSdSdv + pow(_VdT,2)*(_VdSdS*_blackdvdvdv + pow(_VdS,2)*_blackdvdvdvdv + _RdSdS*_blackdrdvdv + pow(_RdS,2)*_blackdrdrdvdv + 2*_VdS*(_RdS*_blackdrdvdvdv + _blackdSdvdvdv) + 2*_RdS*_blackdSdrdvdv + _blackdSdSdvdv) + _RdTdT*_blackdSdSdr + 2*_RdT*_blackdSdSdrdT + 2*_VdT*(pow(_VdS,2)*_blackdvdvdvdT + _RdSdSdT*_blackdrdv + _RdSdS*_blackdrdvdT + _VdSdS*(_blackdvdvdT + _RdT*_blackdrdvdv) + 2*_VdS*(_VdSdT*_blackdvdvdv + _RdSdT*_blackdrdvdv + _RdS*_blackdrdvdvdT) + 2*_RdS*(_VdSdT*_blackdrdvdv + _RdSdT*_blackdrdrdv) + pow(_RdS,2)*_blackdrdrdvdT + 2*_VdSdT*_blackdSdvdv + 2*_RdSdT*_blackdSdrdv + 2*(_VdS*_blackdSdvdvdT + _RdS*_blackdSdrdvdT) + _blackdSdSdvdT + _RdT*(pow(_VdS,2)*_blackdrdvdvdv + _RdSdS*_blackdrdrdv + pow(_RdS,2)*_blackdrdrdrdv + 2*_VdS*(_RdS*_blackdrdrdvdv + _blackdSdrdvdv) + 2*_RdS*_blackdSdrdrdv + _blackdSdSdrdv)) + pow(_RdT,2)*_blackdSdSdrdr;

	return(retVal);
}

double bsmodel_base::dSdr(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdr = RdSdr(params);
	double _Rdr = Rdr(params);
	double _VdS = VdS(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdv = blackdrdv(params);
	double retVal = _RdSdr*_blackdr + _Rdr*(_VdS*_blackdrdv + _RdS*_blackdrdr + _blackdSdr);

	return(retVal);
}

double bsmodel_base::dSdrdr(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdr = RdSdr(params);
	double _RdSdrdr = RdSdrdr(params);
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _VdS = VdS(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double retVal = _RdSdrdr*_blackdr + _Rdrdr*(_VdS*_blackdrdv + _RdS*_blackdrdr + _blackdSdr) + _Rdr*(2*_RdSdr*_blackdrdr + _Rdr*(_VdS*_blackdrdrdv + _RdS*_blackdrdrdr + _blackdSdrdr));

	return(retVal);
}

double bsmodel_base::dSdrdrdr(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdr = RdSdr(params);
	double _RdSdrdr = RdSdrdr(params);
	double _RdSdrdrdr = RdSdrdrdr(params);
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _Rdrdrdr = Rdrdrdr(params);
	double _VdS = VdS(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double retVal = _RdSdrdrdr*_blackdr + _Rdrdrdr*(_VdS*_blackdrdv + _RdS*_blackdrdr + _blackdSdr) + 3*_Rdrdr*(_RdSdr*_blackdrdr + _Rdr*(_VdS*_blackdrdrdv + _RdS*_blackdrdrdr + _blackdSdrdr)) + _Rdr*(3*_RdSdrdr*_blackdrdr + _Rdr*(3*_RdSdr*_blackdrdrdr + _Rdr*(_VdS*_blackdrdrdrdv + _RdS*_blackdrdrdrdr + _blackdSdrdrdr)));

	return(retVal);
}

double bsmodel_base::dSdrdrdv(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdr = RdSdr(params);
	double _RdSdrdr = RdSdrdr(params);
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _VdS = VdS(params);
	double _VdSdv = VdSdv(params);
	double _Vdv = Vdv(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = pow(_Rdr,2)*_VdSdv*_blackdrdrdv + _Rdrdr*(_VdSdv*_blackdrdv + _Vdv*(_VdS*_blackdrdvdv + _RdS*_blackdrdrdv + _blackdSdrdv)) + _Vdv*(_RdSdrdr*_blackdrdv + _Rdr*(2*_RdSdr*_blackdrdrdv + _Rdr*(_VdS*_blackdrdrdvdv + _RdS*_blackdrdrdrdv + _blackdSdrdrdv)));

	return(retVal);
}

double bsmodel_base::dSdrdrdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdSdr = RdSdr(params);
	double _RdSdrdT = RdSdrdT(params);
	double _RdSdrdr = RdSdrdr(params);
	double _RdSdrdrdT = RdSdrdrdT(params);
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _Rdrdr = Rdrdr(params);
	double _RdrdrdT = RdrdrdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdT = VdT(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdT = blackdSdrdT(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdT = blackdSdrdrdT(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _RdSdrdrdT*_blackdr + _RdrdrdT*_VdS*_blackdrdv + _Rdrdr*_VdSdT*_blackdrdv + _RdrdrdT*_RdS*_blackdrdr + _Rdrdr*_RdSdT*_blackdrdr + 2*_RdrdT*_RdSdr*_blackdrdr + 2*_Rdr*_RdSdrdT*_blackdrdr + _RdSdrdr*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + 2*_Rdr*_RdrdT*_VdS*_blackdrdrdv + pow(_Rdr,2)*_VdSdT*_blackdrdrdv + _Rdrdr*_VdS*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + 2*_Rdr*_RdrdT*_RdS*_blackdrdrdr + pow(_Rdr,2)*_RdSdT*_blackdrdrdr + _Rdrdr*_RdS*(_blackdrdrdT + _VdT*_blackdrdrdv + _RdT*_blackdrdrdr) + 2*_Rdr*_RdSdr*(_blackdrdrdT + _VdT*_blackdrdrdv + _RdT*_blackdrdrdr) + pow(_Rdr,2)*_VdS*(_blackdrdrdvdT + _VdT*_blackdrdrdvdv + _RdT*_blackdrdrdrdv) + pow(_Rdr,2)*_RdS*(_blackdrdrdrdT + _VdT*_blackdrdrdrdv + _RdT*_blackdrdrdrdr) + _RdrdrdT*_blackdSdr + 2*_Rdr*_RdrdT*_blackdSdrdr + _Rdrdr*(_blackdSdrdT + _VdT*_blackdSdrdv + _RdT*_blackdSdrdr) + pow(_Rdr,2)*(_blackdSdrdrdT + _VdT*_blackdSdrdrdv + _RdT*_blackdSdrdrdr);

	return(retVal);
}

double bsmodel_base::dSdrdv(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdr = RdSdr(params);
	double _Rdr = Rdr(params);
	double _VdS = VdS(params);
	double _VdSdv = VdSdv(params);
	double _Vdv = Vdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _Rdr*_VdSdv*_blackdrdv + _Vdv*(_RdSdr*_blackdrdv + _Rdr*(_VdS*_blackdrdvdv + _RdS*_blackdrdrdv + _blackdSdrdv));

	return(retVal);
}

double bsmodel_base::dSdrdvdv(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdr = RdSdr(params);
	double _Rdr = Rdr(params);
	double _VdS = VdS(params);
	double _VdSdv = VdSdv(params);
	double _VdSdvdv = VdSdvdv(params);
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = pow(_Vdv,2)*_RdSdr*_blackdrdvdv + _Vdvdv*(_RdSdr*_blackdrdv + _Rdr*(_VdS*_blackdrdvdv + _RdS*_blackdrdrdv + _blackdSdrdv)) + _Rdr*(_VdSdvdv*_blackdrdv + _Vdv*(2*_VdSdv*_blackdrdvdv + _Vdv*(_VdS*_blackdrdvdvdv + _RdS*_blackdrdrdvdv + _blackdSdrdvdv)));

	return(retVal);
}

double bsmodel_base::dSdrdvdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdSdr = RdSdr(params);
	double _RdSdrdT = RdSdrdT(params);
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdSdv = VdSdv(params);
	double _VdSdvdT = VdSdvdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdT = blackdSdrdvdT(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = _VdvdT*_RdSdr*_blackdrdv + _RdrdT*_VdSdv*_blackdrdv + _Vdv*_RdSdrdT*_blackdrdv + _Rdr*_VdSdvdT*_blackdrdv + _Vdv*_RdrdT*_VdS*_blackdrdvdv + _Rdr*_VdvdT*_VdS*_blackdrdvdv + _Rdr*_Vdv*_VdSdT*_blackdrdvdv + _Vdv*_RdrdT*_RdS*_blackdrdrdv + _Rdr*_VdvdT*_RdS*_blackdrdrdv + _Rdr*_Vdv*_RdSdT*_blackdrdrdv + _Vdv*_RdSdr*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + _Rdr*_VdSdv*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + _Rdr*_Vdv*_VdS*(_blackdrdvdvdT + _VdT*_blackdrdvdvdv + _RdT*_blackdrdrdvdv) + _Rdr*_Vdv*_RdS*(_blackdrdrdvdT + _VdT*_blackdrdrdvdv + _RdT*_blackdrdrdrdv) + _Vdv*_RdrdT*_blackdSdrdv + _Rdr*_VdvdT*_blackdSdrdv + _Rdr*_Vdv*(_blackdSdrdvdT + _VdT*_blackdSdrdvdv + _RdT*_blackdSdrdrdv);

	return(retVal);
}

double bsmodel_base::dSdrdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdSdr = RdSdr(params);
	double _RdSdrdT = RdSdrdT(params);
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdT = VdT(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdT = blackdSdrdT(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _RdSdrdT*_blackdr + _RdSdr*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + _RdrdT*(_VdS*_blackdrdv + _RdS*_blackdrdr + _blackdSdr) + _Rdr*(_VdSdT*_blackdrdv + _RdSdT*_blackdrdr + _VdS*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + _RdS*(_blackdrdrdT + _VdT*_blackdrdrdv + _RdT*_blackdrdrdr) + _blackdSdrdT + _VdT*_blackdSdrdv + _RdT*_blackdSdrdr);

	return(retVal);
}

double bsmodel_base::dSdrdTdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdSdTdT = RdSdTdT(params);
	double _RdSdr = RdSdr(params);
	double _RdSdrdT = RdSdrdT(params);
	double _RdSdrdTdT = RdSdrdTdT(params);
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _RdrdTdT = RdrdTdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdSdTdT = VdSdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdT = blackdSdrdT(params);
	double _blackdSdrdTdT = blackdSdrdTdT(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdT = blackdSdrdrdT(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdT = blackdSdrdvdT(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdTdT = blackdrdTdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdTdT = blackdrdrdTdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdTdT = blackdrdvdTdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = _RdSdrdTdT*_blackdr + _RdrdTdT*_VdS*_blackdrdv + 2*_RdrdT*_VdSdT*_blackdrdv + _Rdr*_VdSdTdT*_blackdrdv + _RdrdTdT*_RdS*_blackdrdr + 2*_RdrdT*_RdSdT*_blackdrdr + _Rdr*_RdSdTdT*_blackdrdr + 2*_RdSdrdT*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + 2*_RdrdT*_VdS*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + 2*_Rdr*_VdSdT*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + 2*_RdrdT*_RdS*(_blackdrdrdT + _VdT*_blackdrdrdv + _RdT*_blackdrdrdr) + 2*_Rdr*_RdSdT*(_blackdrdrdT + _VdT*_blackdrdrdv + _RdT*_blackdrdrdr) + _RdSdr*(_blackdrdTdT + _VdTdT*_blackdrdv + _RdTdT*_blackdrdr + 2*_RdT*_blackdrdrdT + _VdT*(2*_blackdrdvdT + _VdT*_blackdrdvdv + 2*_RdT*_blackdrdrdv) + pow(_RdT,2)*_blackdrdrdr) + _Rdr*_VdS*(_blackdrdvdTdT + _VdTdT*_blackdrdvdv + _RdTdT*_blackdrdrdv + 2*_RdT*_blackdrdrdvdT + _VdT*(2*_blackdrdvdvdT + _VdT*_blackdrdvdvdv + 2*_RdT*_blackdrdrdvdv) + pow(_RdT,2)*_blackdrdrdrdv) + _Rdr*_RdS*(_blackdrdrdTdT + _VdTdT*_blackdrdrdv + _RdTdT*_blackdrdrdr + 2*_RdT*_blackdrdrdrdT + _VdT*(2*_blackdrdrdvdT + _VdT*_blackdrdrdvdv + 2*_RdT*_blackdrdrdrdv) + pow(_RdT,2)*_blackdrdrdrdr) + _RdrdTdT*_blackdSdr + 2*_RdrdT*(_blackdSdrdT + _VdT*_blackdSdrdv + _RdT*_blackdSdrdr) + _Rdr*(_blackdSdrdTdT + _VdTdT*_blackdSdrdv + _RdTdT*_blackdSdrdr + 2*_RdT*_blackdSdrdrdT + _VdT*(2*_blackdSdrdvdT + _VdT*_blackdSdrdvdv + 2*_RdT*_blackdSdrdrdv) + pow(_RdT,2)*_blackdSdrdrdr);

	return(retVal);
}

double bsmodel_base::dSdv(const double params[]) const {
	double _RdS = RdS(params);
	double _VdS = VdS(params);
	double _VdSdv = VdSdv(params);
	double _Vdv = Vdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double retVal = _VdSdv*_blackdv + _Vdv*(_VdS*_blackdvdv + _RdS*_blackdrdv + _blackdSdv);

	return(retVal);
}

double bsmodel_base::dSdvdv(const double params[]) const {
	double _RdS = RdS(params);
	double _VdS = VdS(params);
	double _VdSdv = VdSdv(params);
	double _VdSdvdv = VdSdvdv(params);
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _VdSdvdv*_blackdv + _Vdvdv*(_VdS*_blackdvdv + _RdS*_blackdrdv + _blackdSdv) + _Vdv*(2*_VdSdv*_blackdvdv + _Vdv*(_VdS*_blackdvdvdv + _RdS*_blackdrdvdv + _blackdSdvdv));

	return(retVal);
}

double bsmodel_base::dSdvdvdv(const double params[]) const {
	double _RdS = RdS(params);
	double _VdS = VdS(params);
	double _VdSdv = VdSdv(params);
	double _VdSdvdv = VdSdvdv(params);
	double _VdSdvdvdv = VdSdvdvdv(params);
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _Vdvdvdv = Vdvdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdvdvdv*_blackdv + _Vdvdvdv*(_VdS*_blackdvdv + _RdS*_blackdrdv + _blackdSdv) + 3*_Vdvdv*(_VdSdv*_blackdvdv + _Vdv*(_VdS*_blackdvdvdv + _RdS*_blackdrdvdv + _blackdSdvdv)) + _Vdv*(3*_VdSdvdv*_blackdvdv + _Vdv*(3*_VdSdv*_blackdvdvdv + _Vdv*(_VdS*_blackdvdvdvdv + _RdS*_blackdrdvdvdv + _blackdSdvdvdv)));

	return(retVal);
}

double bsmodel_base::dSdvdvdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdT = RdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdSdv = VdSdv(params);
	double _VdSdvdT = VdSdvdT(params);
	double _VdSdvdv = VdSdvdv(params);
	double _VdSdvdvdT = VdSdvdvdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _Vdvdv = Vdvdv(params);
	double _VdvdvdT = VdvdvdT(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdT = blackdSdvdT(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdT = blackdSdvdvdT(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdvdvdT*_blackdv + _VdvdvdT*_VdS*_blackdvdv + _Vdvdv*_VdSdT*_blackdvdv + 2*_VdvdT*_VdSdv*_blackdvdv + 2*_Vdv*_VdSdvdT*_blackdvdv + 2*_Vdv*_VdvdT*_VdS*_blackdvdvdv + pow(_Vdv,2)*_VdSdT*_blackdvdvdv + _VdvdvdT*_RdS*_blackdrdv + _Vdvdv*_RdSdT*_blackdrdv + _VdSdvdv*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + 2*_Vdv*_VdvdT*_RdS*_blackdrdvdv + pow(_Vdv,2)*_RdSdT*_blackdrdvdv + _Vdvdv*_VdS*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv) + 2*_Vdv*_VdSdv*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv) + pow(_Vdv,2)*_VdS*(_blackdvdvdvdT + _VdT*_blackdvdvdvdv + _RdT*_blackdrdvdvdv) + _Vdvdv*_RdS*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + pow(_Vdv,2)*_RdS*(_blackdrdvdvdT + _VdT*_blackdrdvdvdv + _RdT*_blackdrdrdvdv) + _VdvdvdT*_blackdSdv + 2*_Vdv*_VdvdT*_blackdSdvdv + _Vdvdv*(_blackdSdvdT + _VdT*_blackdSdvdv + _RdT*_blackdSdrdv) + pow(_Vdv,2)*(_blackdSdvdvdT + _VdT*_blackdSdvdvdv + _RdT*_blackdSdrdvdv);

	return(retVal);
}

double bsmodel_base::dSdvdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdT = RdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdSdv = VdSdv(params);
	double _VdSdvdT = VdSdvdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdT = blackdSdvdT(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _VdSdvdT*_blackdv + _VdSdv*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + _VdvdT*(_VdS*_blackdvdv + _RdS*_blackdrdv + _blackdSdv) + _Vdv*(_VdSdT*_blackdvdv + _RdSdT*_blackdrdv + _VdS*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv) + _RdS*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + _blackdSdvdT + _VdT*_blackdSdvdv + _RdT*_blackdSdrdv);

	return(retVal);
}

double bsmodel_base::dSdvdTdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdSdTdT = RdSdTdT(params);
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdSdTdT = VdSdTdT(params);
	double _VdSdv = VdSdv(params);
	double _VdSdvdT = VdSdvdT(params);
	double _VdSdvdTdT = VdSdvdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _VdvdTdT = VdvdTdT(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdT = blackdSdrdvdT(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdT = blackdSdvdT(params);
	double _blackdSdvdTdT = blackdSdvdTdT(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdT = blackdSdvdvdT(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdTdT = blackdrdvdTdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdTdT = blackdvdTdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdTdT = blackdvdvdTdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdvdTdT*_blackdv + _VdvdTdT*_VdS*_blackdvdv + 2*_VdvdT*_VdSdT*_blackdvdv + _Vdv*_VdSdTdT*_blackdvdv + _VdvdTdT*_RdS*_blackdrdv + 2*_VdvdT*_RdSdT*_blackdrdv + _Vdv*_RdSdTdT*_blackdrdv + 2*_VdSdvdT*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + 2*_VdvdT*_VdS*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv) + 2*_Vdv*_VdSdT*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv) + 2*_VdvdT*_RdS*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + 2*_Vdv*_RdSdT*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + _VdSdv*(_blackdvdTdT + _VdTdT*_blackdvdv + _RdTdT*_blackdrdv + 2*_RdT*_blackdrdvdT + _VdT*(2*_blackdvdvdT + _VdT*_blackdvdvdv + 2*_RdT*_blackdrdvdv) + pow(_RdT,2)*_blackdrdrdv) + _Vdv*_VdS*(_blackdvdvdTdT + _VdTdT*_blackdvdvdv + _RdTdT*_blackdrdvdv + 2*_RdT*_blackdrdvdvdT + _VdT*(2*_blackdvdvdvdT + _VdT*_blackdvdvdvdv + 2*_RdT*_blackdrdvdvdv) + pow(_RdT,2)*_blackdrdrdvdv) + _Vdv*_RdS*(_blackdrdvdTdT + _VdTdT*_blackdrdvdv + _RdTdT*_blackdrdrdv + 2*_RdT*_blackdrdrdvdT + _VdT*(2*_blackdrdvdvdT + _VdT*_blackdrdvdvdv + 2*_RdT*_blackdrdrdvdv) + pow(_RdT,2)*_blackdrdrdrdv) + _VdvdTdT*_blackdSdv + 2*_VdvdT*(_blackdSdvdT + _VdT*_blackdSdvdv + _RdT*_blackdSdrdv) + _Vdv*(_blackdSdvdTdT + _VdTdT*_blackdSdvdv + _RdTdT*_blackdSdrdv + 2*_RdT*_blackdSdrdvdT + _VdT*(2*_blackdSdvdvdT + _VdT*_blackdSdvdvdv + 2*_RdT*_blackdSdrdvdv) + pow(_RdT,2)*_blackdSdrdrdv);

	return(retVal);
}

double bsmodel_base::dSdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdT = RdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdT = VdT(params);
	double _blackdSdT = blackdSdT(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double retVal = _VdSdT*_blackdv + _RdSdT*_blackdr + _VdS*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + _RdS*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + _blackdSdT + _VdT*_blackdSdv + _RdT*_blackdSdr;

	return(retVal);
}

double bsmodel_base::dSdTdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdSdTdT = RdSdTdT(params);
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdSdTdT = VdSdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _blackdSdTdT = blackdSdTdT(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdT = blackdSdrdT(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdT = blackdSdvdT(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdTdT = blackdrdTdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdTdT = blackdvdTdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _VdSdTdT*_blackdv + _VdS*(_blackdvdTdT + _VdTdT*_blackdvdv) + _RdSdTdT*_blackdr + 2*_RdSdT*_blackdrdT + _RdTdT*_VdS*_blackdrdv + 2*_VdSdT*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + _RdS*(_blackdrdTdT + _VdTdT*_blackdrdv) + 2*_RdT*_VdS*_blackdrdvdT + _RdTdT*_RdS*_blackdrdr + 2*_RdT*_RdSdT*_blackdrdr + 2*_RdT*_RdS*_blackdrdrdT + pow(_RdT,2)*_VdS*_blackdrdrdv + pow(_RdT,2)*_RdS*_blackdrdrdr + _blackdSdTdT + _VdTdT*_blackdSdv + pow(_VdT,2)*(_VdS*_blackdvdvdv + _RdS*_blackdrdvdv + _blackdSdvdv) + _RdTdT*_blackdSdr + 2*_RdT*_blackdSdrdT + 2*_VdT*(_RdSdT*_blackdrdv + _VdS*(_blackdvdvdT + _RdT*_blackdrdvdv) + _RdS*(_blackdrdvdT + _RdT*_blackdrdrdv) + _blackdSdvdT + _RdT*_blackdSdrdv) + pow(_RdT,2)*_blackdSdrdr;

	return(retVal);
}

double bsmodel_base::dSdTdTdT(const double params[]) const {
	double _RdS = RdS(params);
	double _RdSdT = RdSdT(params);
	double _RdSdTdT = RdSdTdT(params);
	double _RdSdTdTdT = RdSdTdTdT(params);
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _RdTdTdT = RdTdTdT(params);
	double _VdS = VdS(params);
	double _VdSdT = VdSdT(params);
	double _VdSdTdT = VdSdTdT(params);
	double _VdSdTdTdT = VdSdTdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _VdTdTdT = VdTdTdT(params);
	double _blackdSdTdTdT = blackdSdTdTdT(params);
	double _blackdSdr = blackdSdr(params);
	double _blackdSdrdT = blackdSdrdT(params);
	double _blackdSdrdTdT = blackdSdrdTdT(params);
	double _blackdSdrdr = blackdSdrdr(params);
	double _blackdSdrdrdT = blackdSdrdrdT(params);
	double _blackdSdrdrdr = blackdSdrdrdr(params);
	double _blackdSdrdrdv = blackdSdrdrdv(params);
	double _blackdSdrdv = blackdSdrdv(params);
	double _blackdSdrdvdT = blackdSdrdvdT(params);
	double _blackdSdrdvdv = blackdSdrdvdv(params);
	double _blackdSdv = blackdSdv(params);
	double _blackdSdvdT = blackdSdvdT(params);
	double _blackdSdvdTdT = blackdSdvdTdT(params);
	double _blackdSdvdv = blackdSdvdv(params);
	double _blackdSdvdvdT = blackdSdvdvdT(params);
	double _blackdSdvdvdv = blackdSdvdvdv(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdTdT = blackdrdTdT(params);
	double _blackdrdTdTdT = blackdrdTdTdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdTdT = blackdrdrdTdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdTdT = blackdrdvdTdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdTdT = blackdvdTdT(params);
	double _blackdvdTdTdT = blackdvdTdTdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdTdT = blackdvdvdTdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdSdTdTdT*_blackdv + 3*_VdSdT*(_blackdvdTdT + _VdTdT*_blackdvdv) + _VdS*(_blackdvdTdTdT + _VdTdTdT*_blackdvdv + 3*_VdTdT*_blackdvdvdT) + _RdSdTdTdT*_blackdr + 3*_RdSdTdT*_blackdrdT + 3*_RdSdT*_blackdrdTdT + _RdTdTdT*_VdS*_blackdrdv + 3*_VdTdT*_RdSdT*_blackdrdv + 3*_RdTdT*_VdSdT*_blackdrdv + 3*_VdSdTdT*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + _RdS*(_blackdrdTdTdT + _VdTdTdT*_blackdrdv) + 3*_VdTdT*_RdS*_blackdrdvdT + 3*_RdTdT*_VdS*_blackdrdvdT + 6*_RdT*_VdSdT*_blackdrdvdT + 3*_RdT*_VdS*_blackdrdvdTdT + 3*_RdT*_VdTdT*_VdS*_blackdrdvdv + _RdTdTdT*_RdS*_blackdrdr + 3*_RdTdT*_RdSdT*_blackdrdr + 3*_RdT*_RdSdTdT*_blackdrdr + 3*_RdTdT*_RdS*_blackdrdrdT + 6*_RdT*_RdSdT*_blackdrdrdT + 3*_RdT*_RdS*_blackdrdrdTdT + 3*_RdT*_VdTdT*_RdS*_blackdrdrdv + 3*_RdT*_RdTdT*_VdS*_blackdrdrdv + 3*pow(_RdT,2)*_VdSdT*_blackdrdrdv + 3*pow(_RdT,2)*_VdS*_blackdrdrdvdT + 3*_RdT*_RdTdT*_RdS*_blackdrdrdr + 3*pow(_RdT,2)*_RdSdT*_blackdrdrdr + 3*pow(_RdT,2)*_RdS*_blackdrdrdrdT + pow(_RdT,3)*_VdS*_blackdrdrdrdv + pow(_RdT,3)*_RdS*_blackdrdrdrdr + _blackdSdTdTdT + _VdTdTdT*_blackdSdv + 3*_VdTdT*_blackdSdvdT + pow(_VdT,3)*(_VdS*_blackdvdvdvdv + _RdS*_blackdrdvdvdv + _blackdSdvdvdv) + _RdTdTdT*_blackdSdr + 3*_RdTdT*_blackdSdrdT + 3*_RdT*_blackdSdrdTdT + 3*_RdT*_VdTdT*_blackdSdrdv + 3*pow(_VdT,2)*(_VdSdT*_blackdvdvdv + _RdSdT*_blackdrdvdv + _VdS*(_blackdvdvdvdT + _RdT*_blackdrdvdvdv) + _RdS*(_blackdrdvdvdT + _RdT*_blackdrdrdvdv) + _blackdSdvdvdT + _RdT*_blackdSdrdvdv) + 3*_RdT*_RdTdT*_blackdSdrdr + 3*pow(_RdT,2)*_blackdSdrdrdT + 3*_VdT*(_RdSdTdT*_blackdrdv + 2*_RdSdT*_blackdrdvdT + 2*_VdSdT*(_blackdvdvdT + _RdT*_blackdrdvdv) + _VdS*(_blackdvdvdTdT + _VdTdT*_blackdvdvdv + _RdTdT*_blackdrdvdv) + _RdS*(_blackdrdvdTdT + _VdTdT*_blackdrdvdv + _RdTdT*_blackdrdrdv) + _blackdSdvdTdT + _VdTdT*_blackdSdvdv + _RdTdT*_blackdSdrdv + _RdT*(_VdS*(2*_blackdrdvdvdT + _RdT*_blackdrdrdvdv) + 2*(_RdSdT*_blackdrdrdv + _RdS*_blackdrdrdvdT + _blackdSdrdvdT) + _RdT*(_RdS*_blackdrdrdrdv + _blackdSdrdrdv))) + pow(_RdT,3)*_blackdSdrdrdr;

	return(retVal);
}

double bsmodel_base::dr(const double params[]) const {
	double _Rdr = Rdr(params);
	double _blackdr = blackdr(params);
	double retVal = _Rdr*_blackdr;

	return(retVal);
}

double bsmodel_base::drdr(const double params[]) const {
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double retVal = _Rdrdr*_blackdr + pow(_Rdr,2)*_blackdrdr;

	return(retVal);
}

double bsmodel_base::drdrdr(const double params[]) const {
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _Rdrdrdr = Rdrdrdr(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double retVal = _Rdrdrdr*_blackdr + 3*_Rdr*_Rdrdr*_blackdrdr + pow(_Rdr,3)*_blackdrdrdr;

	return(retVal);
}

double bsmodel_base::drdrdrdr(const double params[]) const {
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _Rdrdrdr = Rdrdrdr(params);
	double _Rdrdrdrdr = Rdrdrdrdr(params);
	double _blackdr = blackdr(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double retVal = _Rdrdrdrdr*_blackdr + 3*pow(_Rdrdr,2)*_blackdrdr + 4*_Rdr*_Rdrdrdr*_blackdrdr + 6*pow(_Rdr,2)*_Rdrdr*_blackdrdrdr + pow(_Rdr,4)*_blackdrdrdrdr;

	return(retVal);
}

double bsmodel_base::drdrdrdv(const double params[]) const {
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _Rdrdrdr = Rdrdrdr(params);
	double _Vdv = Vdv(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double retVal = _Vdv*(_Rdrdrdr*_blackdrdv + 3*_Rdr*_Rdrdr*_blackdrdrdv + pow(_Rdr,3)*_blackdrdrdrdv);

	return(retVal);
}

double bsmodel_base::drdrdrdT(const double params[]) const {
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _Rdrdr = Rdrdr(params);
	double _RdrdrdT = RdrdrdT(params);
	double _Rdrdrdr = Rdrdrdr(params);
	double _RdrdrdrdT = RdrdrdrdT(params);
	double _VdT = VdT(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double retVal = _RdrdrdrdT*_blackdr + _Rdrdrdr*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + 3*_RdrdT*(_Rdrdr*_blackdrdr + pow(_Rdr,2)*_blackdrdrdr) + _Rdr*(3*_RdrdrdT*_blackdrdr + 3*_Rdrdr*(_blackdrdrdT + _VdT*_blackdrdrdv + _RdT*_blackdrdrdr) + pow(_Rdr,2)*(_blackdrdrdrdT + _VdT*_blackdrdrdrdv + _RdT*_blackdrdrdrdr));

	return(retVal);
}

double bsmodel_base::drdrdv(const double params[]) const {
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _Vdv = Vdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double retVal = _Vdv*(_Rdrdr*_blackdrdv + pow(_Rdr,2)*_blackdrdrdv);

	return(retVal);
}

double bsmodel_base::drdrdvdv(const double params[]) const {
	double _Rdr = Rdr(params);
	double _Rdrdr = Rdrdr(params);
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _Rdrdr*(_Vdvdv*_blackdrdv + pow(_Vdv,2)*_blackdrdvdv) + pow(_Rdr,2)*(_Vdvdv*_blackdrdrdv + pow(_Vdv,2)*_blackdrdrdvdv);

	return(retVal);
}

double bsmodel_base::drdrdvdT(const double params[]) const {
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _Rdrdr = Rdrdr(params);
	double _RdrdrdT = RdrdrdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _VdvdT*(_Rdrdr*_blackdrdv + pow(_Rdr,2)*_blackdrdrdv) + _Vdv*(_RdrdrdT*_blackdrdv + _Rdrdr*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + _Rdr*(2*_RdrdT*_blackdrdrdv + _Rdr*(_blackdrdrdvdT + _VdT*_blackdrdrdvdv + _RdT*_blackdrdrdrdv)));

	return(retVal);
}

double bsmodel_base::drdrdT(const double params[]) const {
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _Rdrdr = Rdrdr(params);
	double _RdrdrdT = RdrdrdT(params);
	double _VdT = VdT(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double retVal = _RdrdrdT*_blackdr + _Rdrdr*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + _Rdr*(2*_RdrdT*_blackdrdr + _Rdr*(_blackdrdrdT + _VdT*_blackdrdrdv + _RdT*_blackdrdrdr));

	return(retVal);
}

double bsmodel_base::drdrdTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _RdrdTdT = RdrdTdT(params);
	double _Rdrdr = Rdrdr(params);
	double _RdrdrdT = RdrdrdT(params);
	double _RdrdrdTdT = RdrdrdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdTdT = blackdrdTdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdTdT = blackdrdrdTdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _RdrdrdTdT*_blackdr + 2*pow(_RdrdT,2)*_blackdrdr + 2*_Rdr*_RdrdTdT*_blackdrdr + 2*_RdrdrdT*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + 4*_Rdr*_RdrdT*(_blackdrdrdT + _VdT*_blackdrdrdv + _RdT*_blackdrdrdr) + _Rdrdr*(_blackdrdTdT + _VdTdT*_blackdrdv + _RdTdT*_blackdrdr + 2*_RdT*_blackdrdrdT + _VdT*(2*_blackdrdvdT + _VdT*_blackdrdvdv + 2*_RdT*_blackdrdrdv) + pow(_RdT,2)*_blackdrdrdr) + pow(_Rdr,2)*(_blackdrdrdTdT + _VdTdT*_blackdrdrdv + _RdTdT*_blackdrdrdr + 2*_RdT*_blackdrdrdrdT + _VdT*(2*_blackdrdrdvdT + _VdT*_blackdrdrdvdv + 2*_RdT*_blackdrdrdrdv) + pow(_RdT,2)*_blackdrdrdrdr);

	return(retVal);
}

double bsmodel_base::drdv(const double params[]) const {
	double _Rdr = Rdr(params);
	double _Vdv = Vdv(params);
	double _blackdrdv = blackdrdv(params);
	double retVal = _Rdr*_Vdv*_blackdrdv;

	return(retVal);
}

double bsmodel_base::drdvdv(const double params[]) const {
	double _Rdr = Rdr(params);
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _Rdr*(_Vdvdv*_blackdrdv + pow(_Vdv,2)*_blackdrdvdv);

	return(retVal);
}

double bsmodel_base::drdvdvdv(const double params[]) const {
	double _Rdr = Rdr(params);
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _Vdvdvdv = Vdvdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = _Rdr*(_Vdvdvdv*_blackdrdv + 3*_Vdv*_Vdvdv*_blackdrdvdv + pow(_Vdv,3)*_blackdrdvdvdv);

	return(retVal);
}

double bsmodel_base::drdvdvdT(const double params[]) const {
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _Vdvdv = Vdvdv(params);
	double _VdvdvdT = VdvdvdT(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = _RdrdT*(_Vdvdv*_blackdrdv + pow(_Vdv,2)*_blackdrdvdv) + _Rdr*(_VdvdvdT*_blackdrdv + _Vdvdv*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + _Vdv*(2*_VdvdT*_blackdrdvdv + _Vdv*(_blackdrdvdvdT + _VdT*_blackdrdvdvdv + _RdT*_blackdrdrdvdv)));

	return(retVal);
}

double bsmodel_base::drdvdT(const double params[]) const {
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _Rdr*_VdvdT*_blackdrdv + _Vdv*(_RdrdT*_blackdrdv + _Rdr*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv));

	return(retVal);
}

double bsmodel_base::drdvdTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _RdrdTdT = RdrdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _VdvdTdT = VdvdTdT(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdTdT = blackdrdvdTdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = 2*_RdrdT*(_VdvdT*_blackdrdv + _Vdv*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv)) + _Rdr*(_VdvdTdT*_blackdrdv + 2*_VdvdT*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv)) + _Vdv*(_RdrdTdT*_blackdrdv + _Rdr*(_blackdrdvdTdT + _VdTdT*_blackdrdvdv + _RdTdT*_blackdrdrdv + 2*_RdT*_blackdrdrdvdT + _VdT*(2*_blackdrdvdvdT + _VdT*_blackdrdvdvdv + 2*_RdT*_blackdrdrdvdv) + pow(_RdT,2)*_blackdrdrdrdv));

	return(retVal);
}

double bsmodel_base::drdT(const double params[]) const {
	double _RdT = RdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _VdT = VdT(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdv = blackdrdv(params);
	double retVal = _RdrdT*_blackdr + _Rdr*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr);

	return(retVal);
}

double bsmodel_base::drdTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _RdrdTdT = RdrdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdTdT = blackdrdTdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double retVal = _RdrdTdT*_blackdr + 2*_RdrdT*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + _Rdr*(_blackdrdTdT + _VdTdT*_blackdrdv + _RdTdT*_blackdrdr + 2*_RdT*_blackdrdrdT + _VdT*(2*_blackdrdvdT + _VdT*_blackdrdvdv + 2*_RdT*_blackdrdrdv) + pow(_RdT,2)*_blackdrdrdr);

	return(retVal);
}

double bsmodel_base::drdTdTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _RdTdTdT = RdTdTdT(params);
	double _Rdr = Rdr(params);
	double _RdrdT = RdrdT(params);
	double _RdrdTdT = RdrdTdT(params);
	double _RdrdTdTdT = RdrdTdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _VdTdTdT = VdTdTdT(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdTdT = blackdrdTdT(params);
	double _blackdrdTdTdT = blackdrdTdTdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdTdT = blackdrdrdTdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdTdT = blackdrdvdTdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double retVal = _RdrdTdTdT*_blackdr + 3*_RdrdTdT*(_blackdrdT + _VdT*_blackdrdv + _RdT*_blackdrdr) + 3*_RdrdT*(_blackdrdTdT + _VdTdT*_blackdrdv + _RdTdT*_blackdrdr + 2*_RdT*_blackdrdrdT + _VdT*(2*_blackdrdvdT + _VdT*_blackdrdvdv + 2*_RdT*_blackdrdrdv) + pow(_RdT,2)*_blackdrdrdr) + _Rdr*(_blackdrdTdTdT + _VdTdTdT*_blackdrdv + pow(_VdT,3)*_blackdrdvdvdv + _RdTdTdT*_blackdrdr + 3*_VdTdT*(_blackdrdvdT + _VdT*_blackdrdvdv + _RdT*_blackdrdrdv) + 3*pow(_VdT,2)*(_blackdrdvdvdT + _RdT*_blackdrdrdvdv) + 3*(_RdTdT*(_blackdrdrdT + _RdT*_blackdrdrdr) + _RdT*(_blackdrdrdTdT + _RdT*_blackdrdrdrdT)) + 3*_VdT*(_blackdrdvdTdT + _RdTdT*_blackdrdrdv + _RdT*(2*_blackdrdrdvdT + _RdT*_blackdrdrdrdv)) + pow(_RdT,3)*_blackdrdrdrdr);

	return(retVal);
}

double bsmodel_base::dv(const double params[]) const {
	double _Vdv = Vdv(params);
	double _blackdv = blackdv(params);
	double retVal = _Vdv*_blackdv;

	return(retVal);
}

double bsmodel_base::dvdv(const double params[]) const {
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double retVal = _Vdvdv*_blackdv + pow(_Vdv,2)*_blackdvdv;

	return(retVal);
}

double bsmodel_base::dvdvdv(const double params[]) const {
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _Vdvdvdv = Vdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _Vdvdvdv*_blackdv + 3*_Vdv*_Vdvdv*_blackdvdv + pow(_Vdv,3)*_blackdvdvdv;

	return(retVal);
}

double bsmodel_base::dvdvdvdv(const double params[]) const {
	double _Vdv = Vdv(params);
	double _Vdvdv = Vdvdv(params);
	double _Vdvdvdv = Vdvdvdv(params);
	double _Vdvdvdvdv = Vdvdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _Vdvdvdvdv*_blackdv + 3*pow(_Vdvdv,2)*_blackdvdv + 4*_Vdv*_Vdvdvdv*_blackdvdv + 6*pow(_Vdv,2)*_Vdvdv*_blackdvdvdv + pow(_Vdv,4)*_blackdvdvdvdv;

	return(retVal);
}

double bsmodel_base::dvdvdvdT(const double params[]) const {
	double _RdT = RdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _Vdvdv = Vdvdv(params);
	double _VdvdvdT = VdvdvdT(params);
	double _Vdvdvdv = Vdvdvdv(params);
	double _VdvdvdvdT = VdvdvdvdT(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdvdvdvdT*_blackdv + 3*_VdvdT*(_Vdvdv*_blackdvdv + pow(_Vdv,2)*_blackdvdvdv) + _Vdvdvdv*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + _Vdv*(3*_VdvdvdT*_blackdvdv + 3*_Vdvdv*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv) + pow(_Vdv,2)*(_blackdvdvdvdT + _VdT*_blackdvdvdvdv + _RdT*_blackdrdvdvdv));

	return(retVal);
}

double bsmodel_base::dvdvdT(const double params[]) const {
	double _RdT = RdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _Vdvdv = Vdvdv(params);
	double _VdvdvdT = VdvdvdT(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _VdvdvdT*_blackdv + _Vdvdv*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + _Vdv*(2*_VdvdT*_blackdvdv + _Vdv*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv));

	return(retVal);
}

double bsmodel_base::dvdvdTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _VdvdTdT = VdvdTdT(params);
	double _Vdvdv = Vdvdv(params);
	double _VdvdvdT = VdvdvdT(params);
	double _VdvdvdTdT = VdvdvdTdT(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdTdT = blackdvdTdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdTdT = blackdvdvdTdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdvdvdTdT*_blackdv + 2*pow(_VdvdT,2)*_blackdvdv + 2*_Vdv*_VdvdTdT*_blackdvdv + 2*_VdvdvdT*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + 4*_Vdv*_VdvdT*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv) + _Vdvdv*(_blackdvdTdT + _VdTdT*_blackdvdv + _RdTdT*_blackdrdv + 2*_RdT*_blackdrdvdT + _VdT*(2*_blackdvdvdT + _VdT*_blackdvdvdv + 2*_RdT*_blackdrdvdv) + pow(_RdT,2)*_blackdrdrdv) + pow(_Vdv,2)*(_blackdvdvdTdT + _VdTdT*_blackdvdvdv + _RdTdT*_blackdrdvdv + 2*_RdT*_blackdrdvdvdT + _VdT*(2*_blackdvdvdvdT + _VdT*_blackdvdvdvdv + 2*_RdT*_blackdrdvdvdv) + pow(_RdT,2)*_blackdrdrdvdv);

	return(retVal);
}

double bsmodel_base::dvdT(const double params[]) const {
	double _RdT = RdT(params);
	double _VdT = VdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double retVal = _VdvdT*_blackdv + _Vdv*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv);

	return(retVal);
}

double bsmodel_base::dvdTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _VdvdTdT = VdvdTdT(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdTdT = blackdvdTdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _VdvdTdT*_blackdv + 2*_VdvdT*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + _Vdv*(_blackdvdTdT + _VdTdT*_blackdvdv + _RdTdT*_blackdrdv + 2*_RdT*_blackdrdvdT + _VdT*(2*_blackdvdvdT + _VdT*_blackdvdvdv + 2*_RdT*_blackdrdvdv) + pow(_RdT,2)*_blackdrdrdv);

	return(retVal);
}

double bsmodel_base::dvdTdTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _RdTdTdT = RdTdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _VdTdTdT = VdTdTdT(params);
	double _Vdv = Vdv(params);
	double _VdvdT = VdvdT(params);
	double _VdvdTdT = VdvdTdT(params);
	double _VdvdTdTdT = VdvdTdTdT(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdTdT = blackdrdvdTdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdTdT = blackdvdTdT(params);
	double _blackdvdTdTdT = blackdvdTdTdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdTdT = blackdvdvdTdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _VdvdTdTdT*_blackdv + 3*_VdvdTdT*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + 3*_VdvdT*(_blackdvdTdT + _VdTdT*_blackdvdv + _RdTdT*_blackdrdv + 2*_RdT*_blackdrdvdT + _VdT*(2*_blackdvdvdT + _VdT*_blackdvdvdv + 2*_RdT*_blackdrdvdv) + pow(_RdT,2)*_blackdrdrdv) + _Vdv*(_blackdvdTdTdT + _VdTdTdT*_blackdvdv + pow(_VdT,3)*_blackdvdvdvdv + _RdTdTdT*_blackdrdv + 3*_VdTdT*(_blackdvdvdT + _VdT*_blackdvdvdv + _RdT*_blackdrdvdv) + 3*pow(_VdT,2)*(_blackdvdvdvdT + _RdT*_blackdrdvdvdv) + 3*(_RdTdT*(_blackdrdvdT + _RdT*_blackdrdrdv) + _RdT*(_blackdrdvdTdT + _RdT*_blackdrdrdvdT)) + 3*_VdT*(_blackdvdvdTdT + _RdTdT*_blackdrdvdv + _RdT*(2*_blackdrdvdvdT + _RdT*_blackdrdrdvdv)) + pow(_RdT,3)*_blackdrdrdrdv);

	return(retVal);
}

double bsmodel_base::dT(const double params[]) const {
	double _RdT = RdT(params);
	double _VdT = VdT(params);
	double _blackdT = blackdT(params);
	double _blackdr = blackdr(params);
	double _blackdv = blackdv(params);
	double retVal = _blackdT + _VdT*_blackdv + _RdT*_blackdr;

	return(retVal);
}

double bsmodel_base::dTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _blackdTdT = blackdTdT(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdv = blackdvdv(params);
	double retVal = _blackdTdT + _VdTdT*_blackdv + _RdTdT*_blackdr + 2*_RdT*_blackdrdT + _VdT*(2*_blackdvdT + _VdT*_blackdvdv + 2*_RdT*_blackdrdv) + pow(_RdT,2)*_blackdrdr;

	return(retVal);
}

double bsmodel_base::dTdTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _RdTdTdT = RdTdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _VdTdTdT = VdTdTdT(params);
	double _blackdTdTdT = blackdTdTdT(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdTdT = blackdrdTdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdTdT = blackdvdTdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double retVal = _blackdTdTdT + _VdTdTdT*_blackdv + pow(_VdT,3)*_blackdvdvdv + _RdTdTdT*_blackdr + 3*_VdTdT*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + 3*pow(_VdT,2)*(_blackdvdvdT + _RdT*_blackdrdvdv) + 3*(_RdTdT*(_blackdrdT + _RdT*_blackdrdr) + _RdT*(_blackdrdTdT + _RdT*_blackdrdrdT)) + 3*_VdT*(_blackdvdTdT + _RdTdT*_blackdrdv + _RdT*(2*_blackdrdvdT + _RdT*_blackdrdrdv)) + pow(_RdT,3)*_blackdrdrdr;

	return(retVal);
}

double bsmodel_base::dTdTdTdT(const double params[]) const {
	double _RdT = RdT(params);
	double _RdTdT = RdTdT(params);
	double _RdTdTdT = RdTdTdT(params);
	double _RdTdTdTdT = RdTdTdTdT(params);
	double _VdT = VdT(params);
	double _VdTdT = VdTdT(params);
	double _VdTdTdT = VdTdTdT(params);
	double _VdTdTdTdT = VdTdTdTdT(params);
	double _blackdTdTdTdT = blackdTdTdTdT(params);
	double _blackdr = blackdr(params);
	double _blackdrdT = blackdrdT(params);
	double _blackdrdTdT = blackdrdTdT(params);
	double _blackdrdTdTdT = blackdrdTdTdT(params);
	double _blackdrdr = blackdrdr(params);
	double _blackdrdrdT = blackdrdrdT(params);
	double _blackdrdrdTdT = blackdrdrdTdT(params);
	double _blackdrdrdr = blackdrdrdr(params);
	double _blackdrdrdrdT = blackdrdrdrdT(params);
	double _blackdrdrdrdr = blackdrdrdrdr(params);
	double _blackdrdrdrdv = blackdrdrdrdv(params);
	double _blackdrdrdv = blackdrdrdv(params);
	double _blackdrdrdvdT = blackdrdrdvdT(params);
	double _blackdrdrdvdv = blackdrdrdvdv(params);
	double _blackdrdv = blackdrdv(params);
	double _blackdrdvdT = blackdrdvdT(params);
	double _blackdrdvdTdT = blackdrdvdTdT(params);
	double _blackdrdvdv = blackdrdvdv(params);
	double _blackdrdvdvdT = blackdrdvdvdT(params);
	double _blackdrdvdvdv = blackdrdvdvdv(params);
	double _blackdv = blackdv(params);
	double _blackdvdT = blackdvdT(params);
	double _blackdvdTdT = blackdvdTdT(params);
	double _blackdvdTdTdT = blackdvdTdTdT(params);
	double _blackdvdv = blackdvdv(params);
	double _blackdvdvdT = blackdvdvdT(params);
	double _blackdvdvdTdT = blackdvdvdTdT(params);
	double _blackdvdvdv = blackdvdvdv(params);
	double _blackdvdvdvdT = blackdvdvdvdT(params);
	double _blackdvdvdvdv = blackdvdvdvdv(params);
	double retVal = _blackdTdTdTdT + _VdTdTdTdT*_blackdv + 6*_VdTdT*_blackdvdTdT + 4*_VdT*_blackdvdTdTdT + 3*pow(_VdTdT,2)*_blackdvdv + pow(_VdT,4)*_blackdvdvdvdv + _RdTdTdTdT*_blackdr + 4*_RdTdTdT*_blackdrdT + 6*_RdTdT*_blackdrdTdT + 4*_RdT*_blackdrdTdTdT + 6*_RdTdT*_VdTdT*_blackdrdv + 4*_VdTdTdT*(_blackdvdT + _VdT*_blackdvdv + _RdT*_blackdrdv) + 12*_RdT*_VdTdT*_blackdrdvdT + 4*pow(_VdT,3)*(_blackdvdvdvdT + _RdT*_blackdrdvdvdv) + 3*pow(_RdTdT,2)*_blackdrdr + 4*_RdT*_RdTdTdT*_blackdrdr + 12*_RdT*_RdTdT*_blackdrdrdT + 6*pow(_RdT,2)*_blackdrdrdTdT + 6*pow(_RdT,2)*_VdTdT*_blackdrdrdv + 6*pow(_VdT,2)*(_blackdvdvdTdT + _VdTdT*_blackdvdvdv + _RdTdT*_blackdrdvdv + 2*_RdT*_blackdrdvdvdT + pow(_RdT,2)*_blackdrdrdvdv) + 6*pow(_RdT,2)*_RdTdT*_blackdrdrdr + 4*pow(_RdT,3)*_blackdrdrdrdT + 4*_VdT*(_RdTdTdT*_blackdrdv + 3*_VdTdT*(_blackdvdvdT + _RdT*_blackdrdvdv) + 3*_RdTdT*(_blackdrdvdT + _RdT*_blackdrdrdv) + 3*_RdT*(_blackdrdvdTdT + _RdT*_blackdrdrdvdT) + pow(_RdT,3)*_blackdrdrdrdv) + pow(_RdT,4)*_blackdrdrdrdr;

	return(retVal);
}

double bsmodel_base::RdS(const double []) const { return(0); }
double bsmodel_base::RdSdS(const double []) const { return(0); }
double bsmodel_base::RdSdSdS(const double []) const { return(0); }
double bsmodel_base::RdSdSdSdS(const double []) const { return(0); }
double bsmodel_base::RdSdSdSdr(const double []) const { return(0); }
double bsmodel_base::RdSdSdSdv(const double []) const { return(0); }
double bsmodel_base::RdSdSdSdT(const double []) const { return(0); }
double bsmodel_base::RdSdSdr(const double []) const { return(0); }
double bsmodel_base::RdSdSdrdr(const double []) const { return(0); }
double bsmodel_base::RdSdSdrdv(const double []) const { return(0); }
double bsmodel_base::RdSdSdrdT(const double []) const { return(0); }
double bsmodel_base::RdSdSdv(const double []) const { return(0); }
double bsmodel_base::RdSdSdvdv(const double []) const { return(0); }
double bsmodel_base::RdSdSdvdT(const double []) const { return(0); }
double bsmodel_base::RdSdSdT(const double []) const { return(0); }
double bsmodel_base::RdSdSdTdT(const double []) const { return(0); }
double bsmodel_base::RdSdr(const double []) const { return(0); }
double bsmodel_base::RdSdrdr(const double []) const { return(0); }
double bsmodel_base::RdSdrdrdr(const double []) const { return(0); }
double bsmodel_base::RdSdrdrdv(const double []) const { return(0); }
double bsmodel_base::RdSdrdrdT(const double []) const { return(0); }
double bsmodel_base::RdSdrdv(const double []) const { return(0); }
double bsmodel_base::RdSdrdvdv(const double []) const { return(0); }
double bsmodel_base::RdSdrdvdT(const double []) const { return(0); }
double bsmodel_base::RdSdrdT(const double []) const { return(0); }
double bsmodel_base::RdSdrdTdT(const double []) const { return(0); }
double bsmodel_base::RdSdv(const double []) const { return(0); }
double bsmodel_base::RdSdvdv(const double []) const { return(0); }
double bsmodel_base::RdSdvdvdv(const double []) const { return(0); }
double bsmodel_base::RdSdvdvdT(const double []) const { return(0); }
double bsmodel_base::RdSdvdT(const double []) const { return(0); }
double bsmodel_base::RdSdvdTdT(const double []) const { return(0); }
double bsmodel_base::RdSdT(const double []) const { return(0); }
double bsmodel_base::RdSdTdT(const double []) const { return(0); }
double bsmodel_base::RdSdTdTdT(const double []) const { return(0); }
double bsmodel_base::Rdr(const double []) const {
	double retVal = 1;
	return(retVal);
}

double bsmodel_base::Rdrdr(const double []) const { return(0); }
double bsmodel_base::Rdrdrdr(const double []) const { return(0); }
double bsmodel_base::Rdrdrdrdr(const double []) const { return(0); }
double bsmodel_base::Rdrdrdrdv(const double []) const { return(0); }
double bsmodel_base::RdrdrdrdT(const double []) const { return(0); }
double bsmodel_base::Rdrdrdv(const double []) const { return(0); }
double bsmodel_base::Rdrdrdvdv(const double []) const { return(0); }
double bsmodel_base::RdrdrdvdT(const double []) const { return(0); }
double bsmodel_base::RdrdrdT(const double []) const { return(0); }
double bsmodel_base::RdrdrdTdT(const double []) const { return(0); }
double bsmodel_base::Rdrdv(const double []) const { return(0); }
double bsmodel_base::Rdrdvdv(const double []) const { return(0); }
double bsmodel_base::Rdrdvdvdv(const double []) const { return(0); }
double bsmodel_base::RdrdvdvdT(const double []) const { return(0); }
double bsmodel_base::RdrdvdT(const double []) const { return(0); }
double bsmodel_base::RdrdvdTdT(const double []) const { return(0); }
double bsmodel_base::RdrdT(const double []) const { return(0); }
double bsmodel_base::RdrdTdT(const double []) const { return(0); }
double bsmodel_base::RdrdTdTdT(const double []) const { return(0); }
double bsmodel_base::Rdv(const double []) const { return(0); }
double bsmodel_base::Rdvdv(const double []) const { return(0); }
double bsmodel_base::Rdvdvdv(const double []) const { return(0); }
double bsmodel_base::Rdvdvdvdv(const double []) const { return(0); }
double bsmodel_base::RdvdvdvdT(const double []) const { return(0); }
double bsmodel_base::RdvdvdT(const double []) const { return(0); }
double bsmodel_base::RdvdvdTdT(const double []) const { return(0); }
double bsmodel_base::RdvdT(const double []) const { return(0); }
double bsmodel_base::RdvdTdT(const double []) const { return(0); }
double bsmodel_base::RdvdTdTdT(const double []) const { return(0); }
double bsmodel_base::RdT(const double []) const { return(0); }
double bsmodel_base::RdTdT(const double []) const { return(0); }
double bsmodel_base::RdTdTdT(const double []) const { return(0); }
double bsmodel_base::RdTdTdTdT(const double []) const { return(0); }
double bsmodel_base::VdS(const double []) const { return(0); }
double bsmodel_base::VdSdS(const double []) const { return(0); }
double bsmodel_base::VdSdSdS(const double []) const { return(0); }
double bsmodel_base::VdSdSdSdS(const double []) const { return(0); }
double bsmodel_base::VdSdSdSdr(const double []) const { return(0); }
double bsmodel_base::VdSdSdSdv(const double []) const { return(0); }
double bsmodel_base::VdSdSdSdT(const double []) const { return(0); }
double bsmodel_base::VdSdSdr(const double []) const { return(0); }
double bsmodel_base::VdSdSdrdr(const double []) const { return(0); }
double bsmodel_base::VdSdSdrdv(const double []) const { return(0); }
double bsmodel_base::VdSdSdrdT(const double []) const { return(0); }
double bsmodel_base::VdSdSdv(const double []) const { return(0); }
double bsmodel_base::VdSdSdvdv(const double []) const { return(0); }
double bsmodel_base::VdSdSdvdT(const double []) const { return(0); }
double bsmodel_base::VdSdSdT(const double []) const { return(0); }
double bsmodel_base::VdSdSdTdT(const double []) const { return(0); }
double bsmodel_base::VdSdr(const double []) const { return(0); }
double bsmodel_base::VdSdrdr(const double []) const { return(0); }
double bsmodel_base::VdSdrdrdr(const double []) const { return(0); }
double bsmodel_base::VdSdrdrdv(const double []) const { return(0); }
double bsmodel_base::VdSdrdrdT(const double []) const { return(0); }
double bsmodel_base::VdSdrdv(const double []) const { return(0); }
double bsmodel_base::VdSdrdvdv(const double []) const { return(0); }
double bsmodel_base::VdSdrdvdT(const double []) const { return(0); }
double bsmodel_base::VdSdrdT(const double []) const { return(0); }
double bsmodel_base::VdSdrdTdT(const double []) const { return(0); }
double bsmodel_base::VdSdv(const double []) const { return(0); }
double bsmodel_base::VdSdvdv(const double []) const { return(0); }
double bsmodel_base::VdSdvdvdv(const double []) const { return(0); }
double bsmodel_base::VdSdvdvdT(const double []) const { return(0); }
double bsmodel_base::VdSdvdT(const double []) const { return(0); }
double bsmodel_base::VdSdvdTdT(const double []) const { return(0); }
double bsmodel_base::VdSdT(const double []) const { return(0); }
double bsmodel_base::VdSdTdT(const double []) const { return(0); }
double bsmodel_base::VdSdTdTdT(const double []) const { return(0); }
double bsmodel_base::Vdr(const double []) const { return(0); }
double bsmodel_base::Vdrdr(const double []) const { return(0); }
double bsmodel_base::Vdrdrdr(const double []) const { return(0); }
double bsmodel_base::Vdrdrdrdr(const double []) const { return(0); }
double bsmodel_base::Vdrdrdrdv(const double []) const { return(0); }
double bsmodel_base::VdrdrdrdT(const double []) const { return(0); }
double bsmodel_base::Vdrdrdv(const double []) const { return(0); }
double bsmodel_base::Vdrdrdvdv(const double []) const { return(0); }
double bsmodel_base::VdrdrdvdT(const double []) const { return(0); }
double bsmodel_base::VdrdrdT(const double []) const { return(0); }
double bsmodel_base::VdrdrdTdT(const double []) const { return(0); }
double bsmodel_base::Vdrdv(const double []) const { return(0); }
double bsmodel_base::Vdrdvdv(const double []) const { return(0); }
double bsmodel_base::Vdrdvdvdv(const double []) const { return(0); }
double bsmodel_base::VdrdvdvdT(const double []) const { return(0); }
double bsmodel_base::VdrdvdT(const double []) const { return(0); }
double bsmodel_base::VdrdvdTdT(const double []) const { return(0); }
double bsmodel_base::VdrdT(const double []) const { return(0); }
double bsmodel_base::VdrdTdT(const double []) const { return(0); }
double bsmodel_base::VdrdTdTdT(const double []) const { return(0); }
double bsmodel_base::Vdv(const double []) const {
	double retVal = 1;
	return(retVal);
}

double bsmodel_base::Vdvdv(const double []) const { return(0); }
double bsmodel_base::Vdvdvdv(const double []) const { return(0); }
double bsmodel_base::Vdvdvdvdv(const double []) const { return(0); }
double bsmodel_base::VdvdvdvdT(const double []) const { return(0); }
double bsmodel_base::VdvdvdT(const double []) const { return(0); }
double bsmodel_base::VdvdvdTdT(const double []) const { return(0); }
double bsmodel_base::VdvdT(const double []) const { return(0); }
double bsmodel_base::VdvdTdT(const double []) const { return(0); }
double bsmodel_base::VdvdTdTdT(const double []) const { return(0); }
double bsmodel_base::VdT(const double []) const { return(0); }
double bsmodel_base::VdTdT(const double []) const { return(0); }
double bsmodel_base::VdTdTdT(const double []) const { return(0); }
double bsmodel_base::VdTdTdTdT(const double []) const { return(0); }
